---
description: 
globs: 
alwaysApply: true
---
# HIVE Monorepo Architecture

This document outlines the structure of the HIVE monorepo to guide AI-assisted development.

## 1. Project Structure

The repository is a `pnpm` workspace-based monorepo managed with `Turborepo`. The main directories are:

- **`apps/`**: Contains consumer-facing applications.
  - `apps/web`: The main Next.js web application.
- **`packages/`**: Contains shared libraries and components.
  - `packages/ui`: The core Storybook-driven UI component library. **All new UI components should go here.**
  - `packages/hooks`: Shared React hooks (e.g., `useSpaces`).
  - `packages/core`: Shared domain logic, types, and constants. Not framework-specific.
  - `packages/config`: Shared configurations (ESLint, TypeScript).
  - `packages/tokens`: Design tokens for styling.

## 2. Path Aliases

Path aliases are used to simplify imports.

- **`@/*`**: Within each `app` or `package`, the `@` alias points to its own `src` directory.
  - In `apps/web`, `@/components/foo` resolves to `apps/web/src/components/foo`.
  - In `packages/ui`, `@/components/bar` resolves to `packages/ui/src/components/bar`.
- **`@hive/*`**: Workspace packages are imported directly by their name, e.g., `@hive/hooks`.

## 3. Storybook Configuration

The primary Storybook instance is located in [`packages/ui`](mdc:packages/ui/package.json). For detailed standards, AI directives, and troubleshooting, refer to the **HIVE Engineering Covenant** rule file.

## 4. Strict Storybook Standards & AI Guardrails

To ensure a stable and maintainable Storybook environment, all AI contributions MUST adhere to the following rules. These are non-negotiable and will be enforced by CI.

### 4.1 ESLint Rules (`plugin:storybook/recommended`)

The following rules are active and must pass for all story-related files.

| Rule ID (eslint-plugin-storybook) | What it flags | Auto-fix? |
| :--- | :--- | :--- |
| `storybook/no-uninstalled-addons` | Addon names in `main.*` that are not in `devDependencies` | — |
| `storybook/prefer-pascal-case` | Story export names not in PascalCase | ✅ |
| `storybook/story-exports` | `.stories.*` file contains zero story exports | — |
| `storybook/default-exports` | Missing default export (i.e. `<Meta>` object) | ✅ |
| `storybook/csf-component` | Default export missing `component:` | — |
| `storybook/no-redundant-story-name` | `name:` duplicates export key | ✅ |
| `storybook/no-title-property-in-meta` | Defining `title` inside `<Meta>` when CSF-3 auto-titles | ✅ |
| `storybook/hierarchy-separator` | Deprecated `|` or `/` in titles | ✅ |
| `storybook/await-interactions` | Missing `await` for `play` function interactions | ✅ |
| `storybook/use-storybook-expect` | Using Jest/Vitest `expect` instead of `@storybook/test`'s | ✅ |

### 4.2 Critical Build & Runtime Errors to Avoid

These common errors will break the build or runtime environment. The AI must never re-introduce them.

| Error / Warning | Root Cause & Fix |
| :--- | :--- |
| **"Multiple main files detected"** | Another `.storybook/main.*` exists elsewhere. Storybook walks the tree up. **Fix:** Ensure only one `main.ts` exists in `packages/ui/.storybook`. |
| **"Using a CommonJS config with Vite is deprecated"** | `main.js` or `postcss.config.js` is CommonJS. **Fix:** All config files must be ESM (`.ts`, `.js` with `"type": "module"`). Use `export default`. |
| **Unresolved addon / "Accessing non-existent addons channel"** | Addon in `addons` array isn't installed or is typo'd. **Fix:** Install the addon or remove the entry from `main.ts`. |
| **Peer-dependency mismatch** | `@storybook/*` packages have different versions (e.g., 8.6 vs 9.0). **Fix:** All `@storybook/*` packages must share the **exact same version**. |
| **Build fails in CI with `Cannot find module 'react/package.json'`** | `react` is hoisted incorrectly. **Fix:** Ensure `react` and `react-dom` are explicit `devDependencies` in `packages/ui/package.json`. |
| **Storybook won't start (no stories found)** | At least one `.stories.tsx` or `.mdx` file must exist. **Fix:** Create a placeholder story if none exist. |

### 4.3 AI Directives for Storybook

The AI MUST follow these directives when performing any work related to Storybook.

1.  **Lock Versions**:
    *   Ensure every `@storybook/*` dependency (including `eslint-plugin-storybook`) shares the **same major.minor tag**.
    *   If using `@next` or `@alpha` tags, they must all match.

2.  **One Config Only**:
    *   There must be **exactly one** `.storybook/main.ts` in the monorepo, located at `packages/ui/.storybook/main.ts`. No stray `main.js` files or secondary configs are permitted.

3.  **ESM Everywhere**:
    *   All Storybook and Vite configuration files (`main.ts`, `preview.ts`, `postcss.config.js`, `tailwind.config.js`) **must be ESM**. Do not use `module.exports` or `require()`.

4.  **Addon Hygiene Checklist**:
    *   Before adding an addon, confirm it exists on npm, matches the core Storybook version, and is added to `devDependencies` in `packages/ui/package.json`.
    *   Immediately remove any addon that causes the "addons channel" error.

5.  **Path Aliases**:
    *   All monorepo path aliases (`@/`, `@hive/core`, etc.) **must be configured** in the `viteFinal` property in `packages/ui/.storybook/main.ts`.

6.  **Story Writing Rules (Enforced by ESLint)**:
    *   Every `.stories.tsx` file must have a `default` export (`const meta = ...; export default meta;`).
    *   The `meta` object must define the `component`.
    *   Every story file must export at least one named story in `PascalCase`.
    *   Do not use the deprecated `storiesOf` API.
    *   Do not use the `name:` property on stories; rely on CSF 3.0 auto-naming from the export key.
    *   **Always** `await` every user interaction inside a `play()` function (e.g., `await userEvent.click(...)`).
    *   Use `expect` from `@storybook/test`, not from other testing libraries.

7.  **CI Smoke Tests**:
    *   `pnpm run test-storybook` (headless test runner) must pass.
    *   `pnpm storybook build` must succeed with zero warnings.
    *   Linting via `eslint --max-warnings 0` must pass.

8.  **Cache Busting Protocol**:
    *   If phantom configuration warnings or unexplainable errors appear, the first step is to delete `node_modules/.cache` and `packages/ui/node_modules/.cache` before restarting Storybook.















