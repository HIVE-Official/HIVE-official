---
description: 
globs: 
alwaysApply: false
---
## 14. STORYBOOK COMPONENT INTERFACE HYGIENE (MANDATORY)

**‚úÖ PROVEN EFFECTIVE** - The following protocols prevent component interface mismatches:

### **Component Props Interface Validation**
# üö® HIVE ENGINEERING: BUILD-SAFETY & LINT COVENANT 2.0 üö®

> **THIS DOCUMENT _REPLACES_ THE PREVIOUS `@error-prevention-and-linting-strict.mdc`.**  
> Compliance is **MANDATORY** for every contributor‚Äîhuman **and** AI.

---

## 1. CORE PRINCIPLE

> **NO CHANGE IS ‚ÄúDONE‚Äù UNTIL THE ENTIRE WORKSPACE BUILDS, TESTS & RENDERS ERROR-FREE.**

All guidelines below exist to guarantee that principle.

---

## 2. ZERO-TOLERANCE CHECKLIST (MUST PASS _BEFORE_ SUBMITTING A PR)

```bash
npx eslint . --max-warnings 15   # ‚â§15 warnings, 0 errors  ‚úÖ
tsc --noEmit                     # TypeScript strict compile ‚úÖ
next build                       # Next.js production build ‚úÖ
pnpm test                        # Vitest unit + Playwright e2e ‚úÖ
pnpm storybook:smoke             # Storybook smoke test (see ¬ß6) ‚úÖ
```

*Any failure blocks merge. Fix it or refuse the task.*

---

## 3. LINT GUARDRAILS

### 3.1 Forbidden Patterns (will **FAIL** lint)

| Category | Violation | Rule |
| --- | --- | --- |
| **Types** | `any`, `as any`, unchecked `unknown` | `@typescript-eslint/no-explicit-any` |
| **Promises** | Floating promises | `@typescript-eslint/no-floating-promises` |
| **Safety** | Unsafe member access/call/assignment | `@typescript-eslint/no-unsafe-*` |
| **Imports** | Non-type import used _only_ for types | `@typescript-eslint/consistent-type-imports` |
| **React** | Missing deps in `useEffect`, invalid list keys | `react-hooks/exhaustive-deps`, `react/jsx-key` |

### 3.2 Required Patterns

1. Type-only imports when value not used:
   ```ts
   import type { User } from '@hive/core'
   ```
2. Explicit return & param types on **all** exported functions/components.
3. Error handling for **every** `await`:
   ```ts
   try {
     const res = await api()
   } catch (err) {
     logger.error(err)
   }
   ```

---

## 4. TYPESCRIPT STRICTNESS

1. **Strict mode required** workspace-wide (see `tsconfig.json`).
2. Runtime unknowns validated with Zod before use.
3. Firestore & API data **must** have matching TypeScript interface **and** Zod schema.

```ts
const PostSchema = z.object({
  id: z.string(),
  body: z.string().min(1),
})

type Post = z.infer<typeof PostSchema>
```

---

## 5. BUILD-TIME SAFETY NETS

### 5.1 Turborepo Targets

* `turbo run lint typecheck build test` automatically enforces sections 2-4.
* CI mirrors the local checklist‚Äîgreen local run = green CI.

### 5.2 Windows Compatibility

Always invoke tools through **`npx`** (binary-path issues solved in Dec 2024 fix).

---

## 6. STORYBOOK CONTRACT

### 6.1 Smoke Test Command

```bash
# package.json (root)
"scripts": {
  "storybook:smoke": "storybook build --dry-run --quiet"
}
```

### 6.2 Prop-Interface Alignment

* Every story's `args` **must** match component prop names & types.
* ESLint rule `storybook/prop-types` is enforced; mismatches fail lint.

Example ‚úÖ:
```ts
interface BadgeProps { label: string; intent?: 'success'|'error' }
export const Primary: StoryObj<BadgeProps> = { args: { label: 'New', intent: 'success' } }
```

Example ‚ùå:
```ts
// label ‚ûú text, intent value invalid
export const Broken = { args: { text: 'New', intent: 'good' } }
```

### 6.3 Runtime Safety

During manual review `pnpm storybook` must render **without console errors**. A single red error banner blocks merge.

---

## 7. COMMON FAILURE PLAYBOOK

| Symptom | Likely Cause | Fix |
| --- | --- | --- |
| `Cannot read properties of undefined` in Storybook | Prop name mismatch | Align `args` with interface (see ¬ß6.2) |
| TypeScript `TS2322` type mismatch | Untyped API / missing generics | Add or refine interfaces; validate data with Zod |
| ESLint `no-unsafe-call` | Using unknown external data | Add guards or schema parse first |
| Next.js build fails at `collectPages` | Client-only code inside Server Component | Add `'use client'` or move logic to client component |

---

## 8. HOW TO COMPLY (STEP-BY-STEP)

1. **Add types & schemas first**‚Äîdon't code blind.
2. Write component **+ story** together; Storybook is your unit test.
3. Run the **Zero-Tolerance Checklist** (section 2).
4. Commit.

üöÄ  _If it passes locally, CI will pass too._

---

## 9. VERSION HISTORY

| Version | Date | Notes |
| --- | --- | --- |
| **2.0** | 2025-06-26 | Full rewrite: merged Storybook contract, Windows fixes & TypeScript strict rules |
| 1.x | 2024 | Original covenant |

---

### Questions?

Open an issue labelled **`build-safety`** and tag *@hive/maintainers*.
