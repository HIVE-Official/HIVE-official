rules_version = '2';

/**
 * HIVE Platform - Firestore Security Rules
 *
 * CRITICAL: These rules are the FIRST LINE OF DEFENSE
 * - Enforce campus isolation at database level
 * - Validate all writes with field-level checks
 * - Role-based access control (admin, leader, moderator, member)
 * - Prevent unauthorized data access
 *
 * Last Updated: 2025-09-29
 * Coverage: 18 collections + subcollections
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS - Security & Validation
    // ============================================================================

    /**
     * Authentication Checks
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /**
     * Admin Role Check
     * NOTE: Uses custom claims set via Firebase Admin SDK
     * Fallback: Check against hardcoded admin emails
     */
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true ||
        request.auth.token.email in [
          'jwrhineh@buffalo.edu',
          'noahowsh@gmail.com'
        ]
      );
    }

    /**
     * Campus Isolation - CRITICAL SECURITY
     * All data must belong to user's campus
     */
    function isSameCampus(campusId) {
      return campusId == 'ub-buffalo'; // vBETA: hardcoded to UB
    }

    function belongsToCampus(data) {
      return data.campusId == 'ub-buffalo';
    }

    /**
     * Space Permissions
     */
    function isSpaceOwner(spaceData) {
      return isAuthenticated() && spaceData.createdBy == request.auth.uid;
    }

    function isSpaceLeader(spaceData) {
      return isAuthenticated() && (
        request.auth.uid in spaceData.leaders ||
        spaceData.createdBy == request.auth.uid
      );
    }

    function isSpaceModerator(spaceData) {
      return isAuthenticated() && (
        request.auth.uid in spaceData.moderators ||
        request.auth.uid in spaceData.leaders ||
        spaceData.createdBy == request.auth.uid
      );
    }

    function isSpaceMember(spaceId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/spaceMembers/$(spaceId + '_' + request.auth.uid));
    }

    /**
     * Field Validation Helpers
     */
    function hasRequiredFields(data, fields) {
      return fields.toSet().difference(data.keys().toSet()).size() == 0;
    }

    function isValidString(value, maxLen) {
      return value is string && value.size() > 0 && value.size() <= maxLen;
    }

    function isValidTimestamp(value) {
      return value is timestamp;
    }


    // ============================================================================
    // CORE COLLECTIONS
    // ============================================================================

    /**
     * USERS COLLECTION
     * User profiles and account data
     */
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();

      // Users can create their own profile
      allow create: if isAuthenticated() &&
        request.auth.uid == userId &&
        belongsToCampus(request.resource.data) &&
        hasRequiredFields(request.resource.data, ['campusId', 'email', 'createdAt']);

      // Users can update their own profile, admins can update any
      allow update: if isUser(userId) || isAdmin();

      // Only admins can delete users
      allow delete: if isAdmin();

      // User subcollections
      match /connections/{connectionId} {
        allow read: if isUser(userId);
        allow write: if isUser(userId);
      }

      match /friendRequests/{requestId} {
        allow read: if isUser(userId) || isUser(resource.data.fromUserId);
        allow create: if isAuthenticated() && request.resource.data.toUserId == userId;
        allow update, delete: if isUser(userId);
      }

      match /calendar/{eventId} {
        allow read, write: if isUser(userId);
      }

      match /notifications/{notificationId} {
        allow read: if isUser(userId);
        allow write: if isAuthenticated(); // Other users can create notifications
      }
    }

    /**
     * SPACES COLLECTION
     * Community spaces with campus isolation
     */
    match /spaces/{spaceId} {
      // Read: Public spaces OR member-only if user is member
      allow read: if isAuthenticated() &&
        belongsToCampus(resource.data) && (
          resource.data.visibility == 'public' ||
          isSpaceMember(spaceId) ||
          isAdmin()
        );

      // Create: Authenticated users with valid data
      allow create: if isAuthenticated() &&
        belongsToCampus(request.resource.data) &&
        request.resource.data.createdBy == request.auth.uid &&
        hasRequiredFields(request.resource.data, [
          'name', 'description', 'category', 'campusId', 'createdBy', 'createdAt'
        ]) &&
        isValidString(request.resource.data.name, 100) &&
        isValidString(request.resource.data.description, 500) &&
        request.resource.data.category in ['university_org', 'student_org', 'residential', 'greek_life'];

      // Update: Leaders, moderators, or admins
      allow update: if isAuthenticated() &&
        belongsToCampus(resource.data) && (
          isSpaceLeader(resource.data) ||
          isAdmin()
        ) &&
        // Prevent changing critical fields
        request.resource.data.campusId == resource.data.campusId &&
        request.resource.data.createdBy == resource.data.createdBy;

      // Delete: Only admins
      allow delete: if isAdmin();

      /**
       * SPACE POSTS SUBCOLLECTION
       * Posts within a space
       */
      match /posts/{postId} {
        // Read: Members or public space
        allow read: if isAuthenticated() && (
          get(/databases/$(database)/documents/spaces/$(spaceId)).data.visibility == 'public' ||
          isSpaceMember(spaceId) ||
          isAdmin()
        );

        // Create: Members can post
        allow create: if isAuthenticated() &&
          isSpaceMember(spaceId) &&
          request.resource.data.authorId == request.auth.uid &&
          hasRequiredFields(request.resource.data, ['authorId', 'content', 'createdAt']);

        // Update: Author or moderators
        allow update: if isAuthenticated() && (
          resource.data.authorId == request.auth.uid ||
          isSpaceModerator(get(/databases/$(database)/documents/spaces/$(spaceId)).data) ||
          isAdmin()
        );

        // Delete: Author, moderators, or admins
        allow delete: if isAuthenticated() && (
          resource.data.authorId == request.auth.uid ||
          isSpaceModerator(get(/databases/$(database)/documents/spaces/$(spaceId)).data) ||
          isAdmin()
        );

        /**
         * POST COMMENTS SUBCOLLECTION
         */
        match /comments/{commentId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() &&
            request.resource.data.authorId == request.auth.uid;
          allow update, delete: if isAuthenticated() && (
            resource.data.authorId == request.auth.uid ||
            isAdmin()
          );
        }
      }

      /**
       * SPACE EVENTS SUBCOLLECTION
       */
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isSpaceMember(spaceId);
        allow update, delete: if isAuthenticated() && (
          resource.data.createdBy == request.auth.uid ||
          isSpaceLeader(get(/databases/$(database)/documents/spaces/$(spaceId)).data) ||
          isAdmin()
        );
      }
    }

    /**
     * SPACE MEMBERS COLLECTION (FLAT STRUCTURE)
     * Tracks membership across all spaces
     */
    match /spaceMembers/{memberId} {
      // Read: Members of the space or admins
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isSpaceMember(resource.data.spaceId) ||
        isAdmin()
      );

      // Create: User joining a space
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        belongsToCampus(request.resource.data) &&
        hasRequiredFields(request.resource.data, ['spaceId', 'userId', 'campusId', 'joinedAt', 'role']);

      // Update: User themselves, space leaders, or admins
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isSpaceLeader(get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data) ||
        isAdmin()
      );

      // Delete: User leaving or being removed by leader/admin
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isSpaceLeader(get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data) ||
        isAdmin()
      );
    }

    /**
     * POSTS COLLECTION (GLOBAL FEED)
     * Campus-wide post aggregation
     */
    match /posts/{postId} {
      allow read: if isAuthenticated() && belongsToCampus(resource.data);

      allow create: if isAuthenticated() &&
        request.resource.data.authorId == request.auth.uid &&
        belongsToCampus(request.resource.data);

      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        isAdmin()
      );

      allow delete: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        isAdmin()
      );
    }

    /**
     * NOTIFICATIONS COLLECTION
     */
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated(); // Any user can create notifications for others
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isUser(resource.data.userId) || isAdmin();
    }

    /**
     * RITUALS COLLECTION
     * Campus-wide campaigns and challenges
     */
    match /rituals/{ritualId} {
      allow read: if isAuthenticated() && belongsToCampus(resource.data);
      allow create: if isAdmin(); // Only admins create rituals
      allow update: if isAdmin();
      allow delete: if isAdmin();

      match /milestones/{milestoneId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
    }

    /**
     * RITUAL PARTICIPATION COLLECTION
     */
    match /ritual_participation/{participationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        belongsToCampus(request.resource.data);

      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isUser(resource.data.userId) || isAdmin();
    }

    /**
     * RITUAL ACTION COMPLETIONS
     */
    match /ritual_action_completions/{completionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    /**
     * TOOLS COLLECTION
     * User-created campus tools
     */
    match /tools/{toolId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublished == true ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        belongsToCampus(request.resource.data);

      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    /**
     * CALENDAR/EVENTS COLLECTION
     */
    match /calendar/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    /**
     * ACTIVITY TRACKING
     */
    match /activity/{activityId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    /**
     * ANALYTICS METRICS
     */
    match /analytics_metrics/{metricId} {
      allow read: if isAdmin() || (
        isAuthenticated() && resource.data.userId == request.auth.uid
      );
      allow write: if isAdmin();
    }

    /**
     * ERROR REPORTS
     */
    match /error_reports/{reportId} {
      allow read: if isAdmin() || (
        isAuthenticated() && resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    /**
     * FEED ITEMS (Promoted Posts)
     */
    match /feed_items/{feedItemId} {
      allow read: if isAuthenticated() && belongsToCampus(resource.data);
      allow write: if isAdmin(); // Only backend/admins manage feed
    }

    /**
     * USER SPACE PREFERENCES
     */
    match /user_space_preferences/{preferenceId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    /**
     * PRESENCE (Real-time user status)
     */
    match /presence/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }

    /**
     * TYPING INDICATORS
     */
    match /typing/{contextId}/users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);
    }


    // ============================================================================
    // VERIFICATION COLLECTIONS (Existing - Keep)
    // ============================================================================

    match /emailVerifications/{docId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    match /verificationRequests/{requestId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    match /user_verifications/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isUser(userId);
    }

    match /claimUpdates/{updateId} {
      allow create, update: if isAdmin();
      allow read: if isAdmin() ||
        (isAuthenticated() && resource.data.userId == request.auth.uid);
    }


    // ============================================================================
    // ADMIN COLLECTIONS
    // ============================================================================

    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // Any operation can log
      allow update, delete: if false; // Audit logs are immutable
    }

    match /moderation_reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
    }

    match /feature_flags/{flagId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }


    // ============================================================================
    // DEFAULT DENY
    // All other collections are denied by default
    // ============================================================================
  }
}