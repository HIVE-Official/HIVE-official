rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================
    // HELPER FUNCTIONS
    // =====================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isEmailVerified() {
      return isAuthenticated() && request.auth.token.email_verified == true;
    }
    
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.get(role, false) == true;
    }
    
    // Check if user is member of space using flat spaceMembers collection
    function isSpaceMember(spaceId) {
      let compositeKey = spaceId + '_' + request.auth.uid;
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/spaceMembers/$(compositeKey));
    }
    
    // Check user's role in space using flat spaceMembers collection
    function getSpaceRole(spaceId) {
      let compositeKey = spaceId + '_' + request.auth.uid;
      return get(/databases/$(database)/documents/spaceMembers/$(compositeKey)).data.role;
    }
    
    function isSpaceOwner(spaceId) {
      return isSpaceMember(spaceId) && getSpaceRole(spaceId) == 'owner';
    }
    
    function isSpaceAdmin(spaceId) {
      return isSpaceMember(spaceId) && 
        getSpaceRole(spaceId) in ['owner', 'admin'];
    }
    
    function isSpaceModerator(spaceId) {
      return isSpaceMember(spaceId) && 
        getSpaceRole(spaceId) in ['owner', 'admin', 'moderator'];
    }
    
    function isValidHandle(handle) {
      return handle is string && 
        handle.size() >= 3 && 
        handle.size() <= 20 &&
        handle.matches('^[a-zA-Z0-9_]+$');
    }
    
    function isValidSchoolEmail(email) {
      return email.matches('.*@buffalo\\.edu$') ||
             email.matches('.*@cornell\\.edu$') ||
             email.matches('.*@columbia\\.edu$') ||
             email.matches('.*@nyu\\.edu$') ||
             email.matches('.*@rit\\.edu$');
    }
    
    // =====================================
    // USER COLLECTIONS
    // =====================================
    
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      allow create: if isUser(userId) && 
        isValidSchoolEmail(request.resource.data.email) &&
        request.resource.data.keys().hasAll(['email', 'fullName', 'handle', 'schoolId']);
      
      allow update: if isUser(userId) || hasRole('admin');
      
      allow delete: if isUser(userId) || hasRole('admin');
      
      // User subcollections
      match /notifications/{notificationId} {
        allow read: if isUser(userId);
        allow write: if false; // Only system can write notifications
      }
      
      match /preferences/{preferenceType} {
        allow read, write: if isUser(userId);
      }
      
      match /analytics/{metricType} {
        allow read: if isUser(userId) || hasRole('admin');
        allow write: if false; // Only system can write analytics
      }
    }
    
    // =====================================
    // HANDLE RESERVATION
    // =====================================
    
    match /handles/{handle} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        isValidHandle(handle) &&
        request.resource.data.userId == request.auth.uid;
      
      allow update: if false; // Handles cannot be updated
      
      allow delete: if isUser(resource.data.userId) || hasRole('admin');
    }
    
    // =====================================
    // SCHOOL COLLECTIONS
    // =====================================
    
    match /schools/{schoolId} {
      allow read: if true; // Public information
      allow write: if hasRole('admin');
    }
    
    // =====================================
    // FLAT SPACE COLLECTIONS
    // =====================================
    
    // Main spaces collection (flat structure)
    match /spaces/{spaceId} {
      allow read: if resource.data.isPublic == true || 
                     isSpaceMember(spaceId) || 
                     hasRole('admin');
      
      allow create: if isEmailVerified() && 
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.keys().hasAll(['name', 'description', 'schoolId', 'category']);
      
      allow update: if isSpaceAdmin(spaceId) || hasRole('admin');
      
      allow delete: if isSpaceOwner(spaceId) || hasRole('admin');
    }
    
    // Flat spaceMembers collection with composite keys
    match /spaceMembers/{memberKey} {
      // memberKey format: spaceId_userId
      allow read: if true; // Public member lists
      
      allow create: if isAuthenticated() && 
        // Either joining yourself or admin adding someone
        (memberKey.matches('.*_' + request.auth.uid + '$') ||
         isSpaceAdmin(memberKey.split('_')[0]) ||
         hasRole('admin')) &&
        request.resource.data.keys().hasAll(['userId', 'spaceId', 'role', 'joinedAt']);
      
      allow update: if isSpaceAdmin(resource.data.spaceId) || 
                       hasRole('admin');
      
      allow delete: if memberKey.matches('.*_' + request.auth.uid + '$') || // Leave space
                       isSpaceAdmin(resource.data.spaceId) || // Admin remove
                       hasRole('admin');
    }
    
    // Flat spacePosts collection
    match /spacePosts/{postId} {
      allow read: if true; // Public posts for now
      
      allow create: if isSpaceMember(request.resource.data.spaceId) &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.keys().hasAll(['spaceId', 'content', 'authorId']);
      
      allow update: if resource.data.authorId == request.auth.uid ||
                       isSpaceModerator(resource.data.spaceId) ||
                       hasRole('admin');
      
      allow delete: if resource.data.authorId == request.auth.uid ||
                       isSpaceModerator(resource.data.spaceId) ||
                       hasRole('admin');
    }
    
    // Flat spaceEvents collection
    match /spaceEvents/{eventId} {
      allow read: if true; // Public events
      
      allow create: if isSpaceMember(request.resource.data.spaceId) &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.keys().hasAll(['spaceId', 'title', 'startTime']);
      
      allow update: if resource.data.createdBy == request.auth.uid ||
                       isSpaceModerator(resource.data.spaceId) ||
                       hasRole('admin');
      
      allow delete: if resource.data.createdBy == request.auth.uid ||
                       isSpaceModerator(resource.data.spaceId) ||
                       hasRole('admin');
    }
    
    // =====================================
    // CREATION ENGINE
    // =====================================
    
    match /tools/{toolId} {
      allow read: if true; // Public tools marketplace
      
      allow create: if isEmailVerified() &&
        request.resource.data.createdBy == request.auth.uid;
      
      allow update: if resource.data.createdBy == request.auth.uid ||
                       hasRole('admin');
      
      allow delete: if resource.data.createdBy == request.auth.uid ||
                       hasRole('admin');
    }
    
    match /templates/{templateId} {
      allow read: if true; // Public templates
      allow write: if hasRole('admin'); // Only admins can manage templates
    }
    
    match /elements/{elementId} {
      allow read: if true; // Public elements
      
      allow create: if isEmailVerified() &&
        request.resource.data.createdBy == request.auth.uid;
      
      allow update: if resource.data.createdBy == request.auth.uid ||
                       hasRole('admin');
      
      allow delete: if resource.data.createdBy == request.auth.uid ||
                       hasRole('admin');
    }
    
    // =====================================
    // FEED & CONTENT
    // =====================================
    
    match /feed/{schoolId}/content/{contentId} {
      allow read: if true; // Public feed
      allow write: if false; // System-generated only
    }
    
    match /feed/{schoolId}/trending/{trendId} {
      allow read: if true; // Public trending
      allow write: if false; // System-generated only
    }
    
    match /topStripContent/{contentId} {
      allow read: if true; // Public top strip
      allow write: if hasRole('admin');
    }
    
    // =====================================
    // ANALYTICS & MODERATION
    // =====================================
    
    match /analytics/{schoolId}/metrics/{metricId} {
      allow read: if hasRole('admin');
      allow write: if false; // System-generated only
    }
    
    match /analytics/{schoolId}/reports/{reportId} {
      allow read: if hasRole('admin');
      allow write: if false; // System-generated only
    }
    
    match /moderation_queue/{reportId} {
      allow read: if hasRole('admin') || hasRole('moderator');
      
      allow create: if isAuthenticated() &&
        request.resource.data.reportedBy == request.auth.uid;
      
      allow update: if hasRole('admin') || hasRole('moderator');
      
      allow delete: if hasRole('admin');
    }
    
    match /safety_reports/{reportId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated();
      allow update, delete: if hasRole('admin');
    }
    
    // =====================================
    // ACTIVITY & ENGAGEMENT
    // =====================================
    
    match /activityEvents/{eventId} {
      allow read: if isAuthenticated();
      allow write: if false; // System-generated only
    }
    
    match /user_behavior/{behaviorId} {
      allow read: if hasRole('admin');
      allow write: if false; // System-generated only
    }
    
    match /content_metrics/{metricId} {
      allow read: if hasRole('admin');
      allow write: if false; // System-generated only
    }
    
    // =====================================
    // PLATFORM ANALYTICS
    // =====================================
    
    match /platform_analytics/{docId} {
      allow read: if hasRole('admin');
      allow write: if false; // System-generated only
    }
    
    // =====================================
    // DEFAULT DENY
    // =====================================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}