rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ======== HELPER FUNCTIONS ========
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isModerator() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }
    
    function isVerified() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator', 'verified'];
    }
    
    function isMember(spaceId, userId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/spaces/$(spaceId)/members/$(userId));
    }

    function isBuilder(spaceId, userId) {
      return isMember(spaceId, userId) &&
             get(/databases/$(database)/documents/spaces/$(spaceId)/members/$(userId)).data.role == 'builder';
    }

    // ======== USER MANAGEMENT ========
    
    match /handles/{handle} {
      allow get: if request.auth != null;
      allow create: if request.auth.uid != null;
    }

    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow get: if resource.data.isPublic == true;
      allow create: if false; // Backend only
      allow update: if request.auth.uid == userId;

      // User subcollections
      match /notifications/{notificationId} {
        allow read, update, delete: if isOwner(userId);
        allow create: if isAdmin() || isOwner(userId);
      }
      
      match /preferences/{preferenceId} {
        allow read, write: if isOwner(userId);
      }
      
      match /analytics/{analyticsId} {
        allow read: if isOwner(userId);
        allow write: if isAdmin();
      }
      
      match /motion/{motionId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      match /personalTools/{toolId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // ======== SCHOOLS ========
    
    match /schools/{schoolId} {
      allow read: if true;
      allow write: if isAdmin();
      
      // School subcollections
      match /feed/{feedId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      match /trending/{trendingId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      match /metrics/{metricId} {
        allow read: if isAdmin();
        allow write: if isAdmin();
      }
    }

    // ======== ONBOARDING & WAITLIST ========
    
    match /onboarding_sessions/{sessionId} {
      allow read: if request.auth.uid == sessionId || 
                 (request.auth != null && resource.data.userId == request.auth.uid);
      allow create: if request.auth.uid == sessionId ||
                   request.resource.data.userId == request.auth.uid;
      allow update: if request.auth.uid == sessionId || 
                   (request.auth != null && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    match /waitlist_entries/{entryId} {
      allow read: if request.auth != null && 
                 (resource.data.email == request.auth.token.email || isAdmin());
      allow create: if request.auth != null && 
                   request.resource.data.email == request.auth.token.email;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    match /school_invitations/{invitationId} {
      allow read: if request.auth != null && 
                 (resource.data.email == request.auth.token.email || 
                  resource.data.invitedBy == request.auth.uid || 
                  isAdmin());
      allow create: if isAuthenticated() && isVerified() &&
                   request.resource.data.invitedBy == request.auth.uid;
      allow update: if request.auth != null && 
                   resource.data.email == request.auth.token.email ||
                   isAdmin();
      allow delete: if isAdmin() || 
                   resource.data.invitedBy == request.auth.uid;
    }
    
    // School metrics (read-only for most, write for admins)
    match /school_metrics/{schoolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ======== SPACES ========
    
    match /spaces/{spaceId} {
      allow get, list: if isAuthenticated();
      allow create, delete: if false; // Backend only
      allow update: if isBuilder(spaceId, request.auth.uid);

      match /members/{userId} {
        allow get, list: if isAuthenticated();
        allow create: if false; // Backend only
        allow delete: if isOwner(userId);
        allow update: if isOwner(userId);
      }
      
      // Space subcollections
      match /analytics/{analyticsId} {
        allow read: if isMember(spaceId, request.auth.uid) || isAdmin();
        allow write: if isAdmin();
      }
      
      match /tools/{toolId} {
        allow read: if isMember(spaceId, request.auth.uid);
        allow create: if isMember(spaceId, request.auth.uid) && isVerified();
        allow update, delete: if isBuilder(spaceId, request.auth.uid) || 
                              resource.data.createdBy == request.auth.uid ||
                              isAdmin();
      }
      
      match /moderation/{moderationId} {
        allow read: if isBuilder(spaceId, request.auth.uid) || isAdmin();
        allow write: if isBuilder(spaceId, request.auth.uid) || isAdmin();
      }
      
      match /posts/{postId} {
        allow get, list: if isMember(spaceId, request.auth.uid);
        allow create: if isMember(spaceId, request.auth.uid);
        allow update: if resource.data.authorId == request.auth.uid || 
                     isBuilder(spaceId, request.auth.uid);
        allow delete: if resource.data.authorId == request.auth.uid || 
                     isBuilder(spaceId, request.auth.uid);
      }
      
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isVerified() && isMember(spaceId, request.auth.uid);
        allow update: if request.auth.uid == resource.data.createdBy || isAdmin();
        allow delete: if request.auth.uid == resource.data.createdBy || isAdmin();
      }
    }

    // ======== CREATION ENGINE ========
    
    match /creation_tools/{toolId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isVerified() &&
                   request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if resource.data.createdBy == request.auth.uid || isAdmin();
    }
    
    match /creation_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isVerified() &&
                   request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if resource.data.createdBy == request.auth.uid || isAdmin();
    }
    
    match /elements/{elementId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /tools/{toolId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.ownerId || 
                           request.auth.uid in resource.data.collaborators;
    }

    // ======== ANALYTICS ========
    
    match /platform_analytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /user_behavior/{behaviorId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow write: if isAdmin();
    }
    
    match /content_metrics/{metricId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ======== MODERATION ========
    
    match /content_reports/{reportId} {
      allow read: if resource.data.reportedBy == request.auth.uid || 
                 isModerator() || isAdmin();
      allow create: if isAuthenticated() && 
                   request.resource.data.reportedBy == request.auth.uid;
      allow update: if isModerator() || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /moderation_queue/{queueId} {
      allow read, write: if isModerator() || isAdmin();
    }
    
    match /moderation_settings/{settingId} {
      allow read: if isModerator() || isAdmin();
      allow write: if isAdmin();
    }
    
    match /safety_reports/{reportId} {
      allow read: if resource.data.reportedBy == request.auth.uid || 
                 isModerator() || isAdmin();
      allow create: if isAuthenticated() && 
                   request.resource.data.reportedBy == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // ======== LEGACY COLLECTIONS ========
    
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isVerified();
      allow update, delete: if request.auth.uid == resource.data.createdBy || isAdmin();
    }

    match /posts/{postId} {
      allow read: if request.auth != null;
    }

    match /feed/{cardId} {
      allow read: if request.auth != null;
      
      match /likes/{userId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // ======== SYSTEM COLLECTIONS ========
    
    match /system_settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /feature_flags/{flagId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /app_config/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /version/{docId} {
      allow read: if true;
    }

    // ======== COLLECTION GROUP QUERIES ========
    
    match /{path=**}/spaces/{spaceId} {
      allow read: if isAuthenticated();
    }
    
    match /{path=**}/events/{eventId} {
      allow read: if isAuthenticated();
    }
    
    match /{path=**}/posts/{postId} {
      allow read: if isAuthenticated();
    }
  }
} 