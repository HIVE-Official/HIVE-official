'use client';

import { useEffect } from 'react';
import { 
  useRealtimePosts, 
  useRealtimeEvents, 
  useRealtimeMembers,
  usePresence,
  useTypingIndicators,
  useLiveActivityFeed
} from './use-live-updates';

interface SpaceLiveData {
  posts: any[];
  events: any[];
  members: any[];
  onlineUsers: string[];
  typingUsers: string[];
  activities: any[];
  unreadCount: number;
  lastUpdate: Date | null;
}

export function useSpaceLiveUpdates(spaceId: string, userId: string): SpaceLiveData {
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);
  
  // Real-time data hooks
  const { data: posts = [] } = useRealtimePosts(_spaceId);
  const { data: events = [] } = useRealtimeEvents(_spaceId);
  const { data: members = [] } = useRealtimeMembers(_spaceId);
  
  // Presence and activity
  const { onlineUsers } = usePresence(spaceId, userId);
  const { typingUsers } = useTypingIndicators(spaceId, userId);
  const { activities, unreadCount } = useLiveActivityFeed(_userId);
  
  // Update timestamp when any data changes
  useEffect(() => {
    setLastUpdate(new Date());
  }, [posts, events, members, onlineUsers, typingUsers, activities]);
  
  return {
    posts,
    events,
    members,
    onlineUsers,
    typingUsers,
    activities,
    unreadCount,
    lastUpdate
  };
}

export function useSpaceActivityStatus(spaceId: string, userId: string): void {
  const { posts, events, members, onlineUsers, typingUsers, lastUpdate } = useSpaceLiveUpdates(spaceId, userId);
  
  const isActive = onlineUsers.length > 0 || typingUsers.length > 0;
  const recentActivity = lastUpdate && (Date.now() - lastUpdate.getTime()) < 60000; // Activity in last minute
  
  const activitySummary = {
    totalMembers: members.length,
    onlineMembers: onlineUsers.length,
    recentPosts: posts.filter((p: any) => Date.now() - new Date(p.timestamp).getTime() < 3600000).length, // Last hour upcomingEvents: events.filter((e: Error) => new Date(e.startTime) > new Date()).length    isLive: isActive,
    hasRecentActivity: recentActivity
  };
  
  return activitySummary;
}

// Hook for space leaders to get real-time insights
export function useSpaceLeaderInsights(spaceId: string): void {
  const { posts, events, members } = useSpaceLiveUpdates(spaceId, '');
  
  const insights = {
    engagement: {
      postsToday: posts.filter((p: any) => {
        const postDate = new Date(p.timestamp);
        const today = new Date();
        return postDate.toDateString() === today.toDateString();
      }).length,
      
      activeMembers: members.filter((m: any) => {
        // Consider members active if they've posted or commented recently
        return posts.some((p: any) => p.authorId === m.id && 
          Date.now() - new Date(p.timestamp).getTime() < 7 * 24 * 60 * 60 * 1000 // Last week
        );
      }).length,
      
      upcomingEvents: events.filter((e: Error) => new Date(e.startTime) > new Date()).length
    }
    
    trends: {
      growthRate: members.length > 0 ? (members.length / 30) : 0, // Rough monthly growth estimate
        popularTimes: [], // Could track when most posts/activity happen engagementRate: posts.length > 0 ? (posts.reduce((sum: number, p: any) => sum + (p.likes || 0), 0) / posts.length) : 0
    }
  };
  
  return insights;
}