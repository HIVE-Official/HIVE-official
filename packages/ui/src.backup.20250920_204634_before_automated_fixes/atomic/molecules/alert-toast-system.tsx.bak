'use client';

import React, { createContext, useContext, useState, useCallback } from 'react';
import { cn } from '../../lib/utils';
import { Button } from '../atoms/button-enhanced';
import { X, CheckCircle, AlertCircle, AlertTriangle, Info } from 'lucide-react';
import { Card } from '../ui/card';

// Alert Types
export type AlertVariant = 'default' | 'success' | 'warning' | 'error' | 'info';
export type AlertSize = 'sm' | 'md' | 'lg';

export interface AlertProps {
  variant?: AlertVariant;
  size?: AlertSize;
  title?: string;
  description?: string;
  icon?: React.ReactNode;
  dismissible?: boolean;
  onDismiss?: () => void;
  actions?: React.ReactNode;
  className?: string;
  children?: React.ReactNode;
}

// Toast Types
export interface ToastProps {
  id: string;
  variant?: AlertVariant;
  title: string;
  description?: string;
  icon?: React.ReactNode;
  duration?: number;
  dismissible?: boolean;
  action?: {
    label: string;
    onClick: () => void;
  };
}

export interface ToastContextValue {
  toasts: ToastProps[];
  addToast: (toast: Omit<ToastProps, 'id'>) => void;
  removeToast: (id: string) => void;
  clearAll: () => void;
}

// Alert Component
export function Alert({
  variant = 'default',
  size = 'md',
  title,
  description,
  icon,
  dismissible = false,
  onDismiss,
  actions,
  className,
  children
}: AlertProps) {
  const getVariantStyles = (variant: AlertVariant) => {
    switch (variant) {
      case 'success':
        return 'bg-[var(--hive-status-success)]/10 border-[var(--hive-status-success)]/20 text-[var(--hive-status-success)]';
      case 'warning':
        return 'bg-[var(--hive-status-warning)]/10 border-[var(--hive-status-warning)]/20 text-[var(--hive-status-warning)]';
      case 'error':
        return 'bg-[var(--hive-status-error)]/10 border-[var(--hive-status-error)]/20 text-[var(--hive-status-error)]';
      case 'info':
        return 'bg-[var(--hive-brand-primary)]/10 border-[var(--hive-brand-primary)]/20 text-[var(--hive-brand-primary)]';
      default:
        return 'bg-[var(--hive-background-secondary)] border-[var(--hive-border-default)] text-[var(--hive-text-primary)]';
    }
  };

  const getDefaultIcon = (variant: AlertVariant) => {
    switch (variant) {
      case 'success':
        return <CheckCircle className="h-4 w-4" />;
      case 'warning':
        return <AlertTriangle className="h-4 w-4" />;
      case 'error':
        return <AlertCircle className="h-4 w-4" />;
      case 'info':
        return <Info className="h-4 w-4" />;
      default:
        return null;
    }
  };

  const sizeClasses = {
    sm: 'p-3 text-sm',
    md: 'p-4 text-base',
    lg: 'p-6 text-lg'
  };

  return (
    <Card className={cn(
      'border rounded-lg',
      getVariantStyles(variant),
      sizeClasses[size],
      className
    )}>
      <div className="flex">
        <div className="flex-shrink-0">
          {icon || getDefaultIcon(variant)}
        </div>
        <div className="ml-3 flex-1">
          {title && (
            <h3 className="text-sm font-medium mb-1">
              {title}
            </h3>
          )}
          {description && (
            <div className="text-sm opacity-90 mb-2">
              {description}
            </div>
          )}
          {children && (
            <div className="mt-2">
              {children}
            </div>
          )}
          {actions && (
            <div className="mt-3">
              {actions}
            </div>
          )}
        </div>
        {dismissible && onDismiss && (
          <div className="flex-shrink-0 ml-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={onDismiss}
              aria-label="Dismiss"
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        )}
      </div>
    </Card>
  );
}

// Toast Context
const ToastContext = createContext<ToastContextValue | undefined>(undefined);

export function useToast(): unknown {
  const context = useContext(ToastContext);
  if (!context) {
    throw new Error('useToast must be used within a ToastProvider');
  }
  return context;
}

// Toast Provider
export function ToastProvider({ children }: { children: React.ReactNode }): void {
  const [toasts, setToasts] = useState<ToastProps[]>([]);

  const addToast = useCallback((toast: Omit<ToastProps, 'id'>) => {
    const id = Math.random().toString(36).substr(2, 9);
    const newToast = { ...toast, id };
    
    setToasts(current => [...current, newToast]);

    // Auto remove toast after duration
    if (toast.duration !== 0) {
      setTimeout(() => {
        removeToast(id);
      }, toast.duration || 5000);
    }
  }, []);

  const removeToast = useCallback((id: string) => {
    setToasts(current => current.filter(toast => toast.id !== id));
  }, []);

  const clearAll = useCallback(() => {
    setToasts([]);
  }, []);

  return (
    <ToastContext.Provider value={{ toasts, addToast, removeToast, clearAll }}>
      {children}
      <ToastContainer />
    </ToastContext.Provider>
  );
}

// Individual Toast Component
function Toast({
  id,
  variant = 'default',
  title,
  description,
  icon,
  dismissible = true,
  action
}: ToastProps) {
  const { removeToast } = useToast();

  const getVariantStyles = (variant: AlertVariant) => {
    switch (variant) {
      case 'success':
        return 'bg-[var(--hive-status-success)] text-[var(--hive-text-inverse)]';
      case 'warning':
        return 'bg-[var(--hive-status-warning)] text-[var(--hive-text-inverse)]';
      case 'error':
        return 'bg-[var(--hive-status-error)] text-[var(--hive-text-inverse)]';
      case 'info':
        return 'bg-[var(--hive-brand-primary)] text-[var(--hive-text-inverse)]';
      default:
        return 'bg-[var(--hive-background-primary)] text-[var(--hive-text-primary)] border border-[var(--hive-border-default)]';
    }
  };

  const getDefaultIcon = (variant: AlertVariant) => {
    switch (variant) {
      case 'success':
        return <CheckCircle className="h-5 w-5" />;
      case 'warning':
        return <AlertTriangle className="h-5 w-5" />;
      case 'error':
        return <AlertCircle className="h-5 w-5" />;
      case 'info':
        return <Info className="h-5 w-5" />;
      default:
        return null;
    }
  };

  return (
    <Card className={cn(
      'p-4 shadow-lg animate-in slide-in-from-right-full',
      getVariantStyles(variant)
    )}>
      <div className="flex items-start">
        <div className="flex-shrink-0">
          {icon || getDefaultIcon(variant)}
        </div>
        <div className="ml-3 flex-1">
          <p className="text-sm font-medium">{title}</p>
          {description && (
            <p className="mt-1 text-sm opacity-90">{description}</p>
          )}
          {action && (
            <div className="mt-3">
              <Button
                variant="secondary"
                size="sm"
                onClick={action.onClick}
              >
                {action.label}
              </Button>
            </div>
          )}
        </div>
        {dismissible && (
          <div className="flex-shrink-0 ml-4">
            <Button
              variant="ghost"
              size="icon"
              onClick={() => removeToast(id)}
              aria-label="Dismiss"
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        )}
      </div>
    </Card>
  );
}

// Toast Container
function ToastContainer(): void {
  const { toasts } = useToast();

  if (toasts.length === 0) return null;

  return (
    <div className="fixed top-0 right-0 z-50 w-full max-w-sm p-4 space-y-2 pointer-events-none">
      {toasts.map((toast) => (
        <div key={toast.id} className="pointer-events-auto">
          <Toast {...toast} />
        </div>
      ))}
    </div>
  );
}

// Helper functions for common toast patterns
export const toast: Record<string, unknown> = {
  success: (title: string, description?: string, options?: Partial<ToastProps>) => ({
    variant: 'success' as const,
    title,
    description,
    ...options
  }),
  
  error: (title: string, description?: string, options?: Partial<ToastProps>) => ({
    variant: 'error' as const,
    title,
    description,
    ...options
  }),
  
  warning: (title: string, description?: string, options?: Partial<ToastProps>) => ({
    variant: 'warning' as const,
    title,
    description,
    ...options
  }),
  
  info: (title: string, description?: string, options?: Partial<ToastProps>) => ({
    variant: 'info' as const,
    title,
    description,
    ...options
  }),
  
  default: (title: string, description?: string, options?: Partial<ToastProps>) => ({
    variant: 'default' as const,
    title,
    description,
    ...options
  })
};

// Alert presets for common use cases
export const AlertPresets: Record<string, unknown> = {
  // Error boundary alert  ErrorBoundary: (props: Omit<AlertProps, 'variant' | 'dismissible'>) => (
    <Alert variant="error" dismissible={false} {...props} />
  ),
  
  // Success confirmation  Success: (props: Omit<AlertProps, 'variant'>) => (
    <Alert variant="success" {...props} />
  ),
  
  // Warning notification  Warning: (props: Omit<AlertProps, 'variant'>) => (
    <Alert variant="warning" {...props} />
  ),
  
  // Information notice  Info: (props: Omit<AlertProps, 'variant'>) => (
    <Alert variant="info" {...props} />
  )
};

// Types already exported inline above