/**
 * HIVE Social Interaction Molecule
 * Campus-optimized social action group - like/comment/share button combination
 * 
 * Built using all foundation systems:
 * - Motion: Spring physics social feedback and liquid interaction animations
 * - Typography: Consistent action labels and count formatting  
 * - Color: Campus semantic colors and interaction state feedback
 * - Layout: Systematic spacing between social actions
 * - Icon: Social action icons with proper sizing across variants
 * - Interaction: Hover states, active feedback, and social confirmation
 * - Shadow: Subtle elevation for interactive social buttons
 * - Border: Consistent radius and action button styling
 */

import React, { useState } from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '../../lib/utils';

// Foundation system imports
import { motionComposition } from '../foundations/motion-composition';
import { typographyComposition } from '../foundations/typography-composition';
import { colorComposition } from '../foundations/color-composition';
import { layoutComposition } from '../foundations/layout-composition';
import { 
  iconComposition, 
  Heart, 
  MessageCircle, 
  Share2,
  ThumbsUp
} from '../foundations/icon-composition';
import { interactionComposition } from '../foundations/interaction-composition';
import { shadowComposition } from '../foundations/shadow-composition';
import { borderComposition } from '../foundations/border-composition';

// === SOCIAL INTERACTION VARIANTS ===
const socialInteractionVariants = cva(
  // Base styles using foundation systems
  [
    // Layout foundation
    layoutComposition.utils.flex.row,
    layoutComposition.utils.gap[4], // 16px gap between actions
    'items-center',
    
    // Campus social context
    'group'
  ].join(' '),
  {
    variants: {
      size: {
        // Icon and typography sizing using foundation systems
        small: [
          // Button sizing
          '[&_.hive-social-btn]:h-8', // 32px height
          '[&_.hive-social-btn]:px-3', // 12px horizontal padding
          '[&_.hive-social-btn]:gap-1.5', // 6px icon-text gap
          // Icon sizing
          `[&_.hive-social-icon]:${iconComposition.sizes.small.className}`, // 16px
          // Typography
          `[&_.hive-social-count]:text-[${typographyComposition.scale.small.size}]`, // 14px
          `[&_.hive-social-label]:text-[${typographyComposition.scale.caption.size}]` // 12px
        ],
        base: [
          // Button sizing
          '[&_.hive-social-btn]:h-10', // 40px height
          '[&_.hive-social-btn]:px-4', // 16px horizontal padding
          '[&_.hive-social-btn]:gap-2', // 8px icon-text gap
          // Icon sizing
          `[&_.hive-social-icon]:${iconComposition.sizes.base.className}`, // 20px
          // Typography
          `[&_.hive-social-count]:text-[${typographyComposition.scale.base.size}]`, // 16px
          `[&_.hive-social-label]:text-[${typographyComposition.scale.small.size}]` // 14px
        ],
        large: [
          // Button sizing
          '[&_.hive-social-btn]:h-12', // 48px height
          '[&_.hive-social-btn]:px-5', // 20px horizontal padding
          '[&_.hive-social-btn]:gap-2.5', // 10px icon-text gap
          // Icon sizing
          `[&_.hive-social-icon]:${iconComposition.sizes.large.className}`, // 24px
          // Typography
          `[&_.hive-social-count]:text-[${typographyComposition.scale.large.size}]`, // 18px
          `[&_.hive-social-label]:text-[${typographyComposition.scale.base.size}]` // 16px
        ]
      }
      
      layout: {
        // Horizontal with labels (default) horizontal: layoutComposition.utils.flex.row        
        // Compact icons only
        compact: [
          layoutComposition.utils.flex.row,
          layoutComposition.utils.gap[2] // 8px tighter gap
        ].join(' '),
        
        // Vertical stack (mobile optimization)
        vertical: [
          layoutComposition.utils.flex.col,
          layoutComposition.utils.gap[2], // 8px vertical gap
          'items-start'
        ].join(' ')
      }
      
      variant: {
        // Default campus theme default: ''        
        // High contrast for accessibility
        contrast: [
          '[&_.hive-social-btn]:bg-[var(--hive-bg-secondary)]',
          '[&_.hive-social-btn]:border',
          '[&_.hive-social-btn]:border-[var(--hive-border-subtle)]'
        ].join(' '),
        
        // Minimal ghost style
        ghost: [
          '[&_.hive-social-btn]:bg-transparent',
          '[&_.hive-social-btn]:hover:bg-[var(--hive-bg-subtle)]'
        ].join(' ')
      }
    }
    
    defaultVariants: {
      size: 'base',
      layout: 'horizontal',
      variant: 'default'
    }
  }
);

// === SOCIAL ACTION TYPES ===
export type SocialActionType = 'like' | 'comment' | 'share';

export interface SocialActionData {
  type: SocialActionType;
  count: number;
  isActive: boolean;
  label?: string;
}

// === COMPONENT PROPS ===
export interface SocialInteractionProps 
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof socialInteractionVariants> {
  
  // Social data actions: SocialActionData[];
  
  // Visual options
  showLabels?: boolean;
  showCounts?: boolean;
  
  // Campus context
  disabled?: boolean;
  
  // Interaction callbacks
  onAction?: (actionType: SocialActionType) => void;
  onLike?: () => void;
  onComment?: () => void;
  onShare?: () => void;
}

// === ACTION CONFIGURATION ===
const actionConfig = {
  like: {
    icon: Heart,
    defaultLabel: 'Like',
    activeColor: 'text-[var(--hive-error-primary)]', // Red heart for likes activeBg: 'bg-[var(--hive-error-background)]'    activeBorder: 'border-[var(--hive-error-border)]',
    hoverColor: 'hover:text-[var(--hive-error-primary)]',
    hoverBg: 'hover:bg-[var(--hive-error-background)]/50',
    // Spring animation for like action animation: motionComposition.social.like
  }
  comment: {
    icon: MessageCircle,
    defaultLabel: 'Comment',
    activeColor: 'text-[var(--hive-info-primary)]', // Blue for comments activeBg: 'bg-[var(--hive-info-background)]'    activeBorder: 'border-[var(--hive-info-border)]',
    hoverColor: 'hover:text-[var(--hive-info-primary)]',
    hoverBg: 'hover:bg-[var(--hive-info-background)]/50',
    animation: motionComposition.social.comment
  }
  share: {
    icon: Share2,
    defaultLabel: 'Share',
    activeColor: 'text-[var(--hive-success-primary)]', // Green for shares activeBg: 'bg-[var(--hive-success-background)]'    activeBorder: 'border-[var(--hive-success-border)]',
    hoverColor: 'hover:text-[var(--hive-success-primary)]',
    hoverBg: 'hover:bg-[var(--hive-success-background)]/50',
    animation: motionComposition.social.share
  }
} as const;

// === FORMAT COUNT UTILITY ===
const formatCount = (count: number): string => {
  if (count < 1000) return count.toString();
  if (count < 10000) return `${(count / 1000).toFixed(1)}k`;
  if (count < 1000000) return `${Math.floor(count / 1000)}k`;
  return `${(count / 1000000).toFixed(1)}M`;
};

// === SOCIAL ACTION BUTTON ===
interface SocialActionButtonProps {
  action: SocialActionData;
  showLabel: boolean;
  showCount: boolean;
  disabled: boolean;
  onClick: () => void;
}

const SocialActionButton = React.forwardRef<HTMLButtonElement, SocialActionButtonProps>(
  ({ action, showLabel, showCount, disabled, onClick }, ref) => {
    const config = actionConfig[action.type];
    const IconComponent = config.icon;
    const [isAnimating, setIsAnimating] = useState(false);
    
    const handleClick = (): void => {
      if (disabled) return;
      
      // Trigger social animation
      setIsAnimating(true);
      setTimeout(() => setIsAnimating(false), 300);
      
      onClick();
    };
    
    return (
      <button
        ref={ref}
        className={cn(
          // Base button styles using foundation systems
          'hive-social-btn',
          'inline-flex items-center justify-center',
          'relative',
          'rounded-lg',
          'font-[var(--hive-font-family-primary)]',
          'font-medium',
          'text-[var(--hive-text-secondary)]',
          'bg-transparent',
          
          // Border foundation
          'border border-transparent',
          
          // Interaction foundation
          'cursor-pointer',
          'transition-all',
          'duration-[150ms]',
          'active:scale-95',
          
          // Focus ring using border foundation
          'focus:outline-none focus:ring-2 focus:ring-[var(--hive-gold-primary)]/20',
          
          // Campus social hover effects
          !action.isActive && [
            config.hoverColor,
            config.hoverBg,
            'hover:border-current'
          ].join(' '),
          
          // Active state styling
          action.isActive && [
            config.activeColor,
            config.activeBg,
            config.activeBorder,
            // Shadow using shadow foundation
            shadowComposition.interactive.buttons.primary.active
          ].join(' '),
          
          // Animation state
          isAnimating && 'animate-pulse',
          
          // Disabled state
          disabled && [
            'opacity-50',
            'cursor-not-allowed',
            'hover:bg-transparent',
            'hover:text-[var(--hive-text-secondary)]'
          ].join(' ')
        )}
        disabled={disabled}
        onClick={handleClick}
        aria-pressed={action.isActive}
        title={`${action.label || config.defaultLabel}${showCount ? ` (${action.count})` : ''}`}
      >
        {/* Icon */}
        <IconComponent 
          className={cn(
            'hive-social-icon',
            'shrink-0',
            // Motion foundation - smooth icon transitions
            'transition-transform duration-[150ms]',
            // Social animation on active
            action.isActive && isAnimating && 'scale-110 rotate-6'
          )}
        />
        
        {/* Label and Count */}
        {(showLabel || showCount) && (
          <div className="flex items-center gap-1.5">
            {/* Label */}
            {showLabel && (
              <span className="hive-social-label">
                {action.label || config.defaultLabel}
              </span>
            )}
            
            {/* Count */}
            {showCount && action.count > 0 && (
              <span 
                className={cn(
                  'hive-social-count',
                  'font-[var(--hive-font-family-primary)]',
                  'font-medium',
                  'tabular-nums', // Consistent number width
                  // Slightly muted when not active
                  !action.isActive && 'text-[var(--hive-text-muted)]',
                  // Motion foundation - smooth count updates
                  'transition-all duration-[150ms]'
                )}
              >
                {formatCount(action.count)}
              </span>
            )}
          </div>
        )}
      </button>
    );
  }
);

SocialActionButton.displayName = 'SocialActionButton';

// === MAIN COMPONENT ===
export const SocialInteraction = React.forwardRef<HTMLDivElement, SocialInteractionProps>(
  ({
    className,
    size,
    layout,
    variant,
    actions,
    showLabels = true,
    showCounts = true,
    disabled = false,
    onAction,
    onLike,
    onComment,
    onShare,
    ...props
  }, ref) => {
    
    const handleActionClick = (actionType: SocialActionType) => {
      // Call general action handler
      onAction?.(actionType);
      
      // Call specific action handlers
      switch (actionType) {
        case 'like':
          onLike?.();
          break;
        case 'comment':
          onComment?.();
          break;
        case 'share':
          onShare?.();
          break;
      }
    };
    
    return (
      <div
        ref={ref}
        className={cn(socialInteractionVariants({ size, layout, variant }), className)}
        role="group"
        aria-label="Social actions"
        {...props}
      >
        {actions.map((action: SocialActionData) => (
          <SocialActionButton
            key={action.type}
            action={action}
            showLabel={layout !== 'compact' && showLabels}
            showCount={showCounts}
            disabled={disabled}
            onClick={() => handleActionClick(action.type)}
          />
        ))}
      </div>
    );
  }
);

SocialInteraction.displayName = 'SocialInteraction';

// Types already exported inline above
export { socialInteractionVariants, actionConfig, formatCount };