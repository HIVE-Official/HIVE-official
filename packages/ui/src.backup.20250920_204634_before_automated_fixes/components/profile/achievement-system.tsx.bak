'use client';

import React, { useState, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Award, 
  Star, 
  Crown, 
  Trophy, 
  Target, 
  Zap,
  Users,
  Calendar,
  Flame,
  Shield,
  Book,
  Code,
  Heart,
  TrendingUp,
  Rocket,
  Diamond,
  Lock,
  Unlock,
  Gift,
  Medal,
  CheckCircle,
  Clock,
  Progress,
  Filter,
  Search,
  Share2,
  Download,
  Eye,
  EyeOff
} from 'lucide-react';
import { HiveCard } from '../hive-card';
import { HiveButton } from '../hive-button';
import { Badge } from '../../atomic/atoms/badge';
import { cn } from '../../lib/utils';

// Achievement System Types
export interface Achievement {
  id: string;
  name: string;
  description: string;
  longDescription?: string;
  icon: string;
  category: AchievementCategory;
  rarity: AchievementRarity;
  points: number;
  unlockCriteria: UnlockCriteria;
  rewards?: AchievementReward[];
  
  // Status
  status: 'locked' | 'available' | 'in_progress' | 'completed';
  progress?: {
    current: number;
    total: number;
    unit?: string;
  };
  unlockedAt?: string;
  claimedAt?: string;
  
  // Metadata
  isSecret: boolean;
  isLimited: boolean;
  limitedUntil?: string;
  prerequisites?: string[];
  
  // Social
  completedBy: number; // Number of users who completed this
  completionRate: number; // Percentage of users who completed this
}

export type AchievementCategory = 
  | 'builder' 
  | 'social' 
  | 'academic' 
  | 'community' 
  | 'milestone' 
  | 'seasonal' 
  | 'special';

export type AchievementRarity = 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary';

export interface UnlockCriteria {
  type: 'count' | 'streak' | 'time' | 'rating' | 'collaboration' | 'milestone';
  target: number;
  timeframe?: 'day' | 'week' | 'month' | 'semester' | 'year';
  conditions?: Record<string, any>;
}

export interface AchievementReward {
  type: 'badge' | 'title' | 'feature' | 'cosmetic' | 'xp' | 'boost';
  value: string | number;
  duration?: number; // For temporary rewards (in days)
}

export interface AchievementStats {
  totalEarned: number;
  totalAvailable: number;
  totalPoints: number;
  completionRate: number;
  recentAchievements: Achievement[];
  streaks: {
    current: number;
    longest: number;
    type: string;
  }[];
  leaderboardRank?: {
    position: number;
    total: number;
    percentile: number;
  };
}

interface AchievementSystemProps {
  achievements: Achievement[];
  stats: AchievementStats;
  isOwnProfile?: boolean;
  onAchievementClick?: (achievement: Achievement) => void;
  onClaimReward?: (achievement: Achievement) => void;
  onShareAchievement?: (achievement: Achievement) => void;
  className?: string;
}

export const AchievementSystem: React.FC<AchievementSystemProps> = ({
  achievements,
  stats,
  isOwnProfile = false,
  onAchievementClick,
  onClaimReward,
  onShareAchievement,
  className
}) => {
  const [activeTab, setActiveTab] = useState<'overview' | 'earned' | 'progress' | 'available'>('overview');
  const [selectedCategory, setSelectedCategory] = useState<AchievementCategory | 'all'>('all');
  const [selectedRarity, setSelectedRarity] = useState<AchievementRarity | 'all'>('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [showSecrets, setShowSecrets] = useState(false);

  const categories: { id: AchievementCategory | 'all'; label: string; icon: React.ReactNode }[] = [
    { id: 'all', label: 'All', icon: <Award className="h-4 w-4" /> },
    { id: 'builder', label: 'Builder', icon: <Code className="h-4 w-4" /> },
    { id: 'social', label: 'Social', icon: <Users className="h-4 w-4" /> },
    { id: 'academic', label: 'Academic', icon: <Book className="h-4 w-4" /> },
    { id: 'community', label: 'Community', icon: <Heart className="h-4 w-4" /> },
    { id: 'milestone', label: 'Milestone', icon: <Target className="h-4 w-4" /> },
    { id: 'seasonal', label: 'Seasonal', icon: <Calendar className="h-4 w-4" /> },
    { id: 'special', label: 'Special', icon: <Star className="h-4 w-4" /> }
  ];

  const rarities: { id: AchievementRarity | 'all'; label: string; color: string }[] = [
    { id: 'all', label: 'All Rarities', color: 'text-hive-text-secondary' },
    { id: 'common', label: 'Common', color: 'text-gray-400' },
    { id: 'uncommon', label: 'Uncommon', color: 'text-green-400' },
    { id: 'rare', label: 'Rare', color: 'text-blue-400' },
    { id: 'epic', label: 'Epic', color: 'text-purple-400' },
    { id: 'legendary', label: 'Legendary', color: 'text-yellow-400' }
  ];

  const filteredAchievements = useMemo(() => {
    let filtered = achievements;

    // Filter by tab
    switch (activeTab) {
      case 'earned':
        filtered = filtered.filter(a => a.status === 'completed');
        break;
      case 'progress':
        filtered = filtered.filter(a => a.status === 'in_progress');
        break;
      case 'available':
        filtered = filtered.filter(a => a.status === 'available' || a.status === 'locked');
        break;
    }

    // Filter by category
    if (selectedCategory !== 'all') {
      filtered = filtered.filter(a => a.category === selectedCategory);
    }

    // Filter by rarity
    if (selectedRarity !== 'all') {
      filtered = filtered.filter(a => a.rarity === selectedRarity);
    }

    // Filter by search
    if (searchQuery) {
      filtered = filtered.filter(a => 
        a.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        a.description.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    // Filter secrets
    if (!showSecrets) {
      filtered = filtered.filter(a => !a.isSecret || a.status === 'completed');
    }

    return filtered;
  }, [achievements, activeTab, selectedCategory, selectedRarity, searchQuery, showSecrets]);

  const getRarityColor = (rarity: AchievementRarity): string => {
    const rarityItem = rarities.find(r => r.id === rarity);
    return rarityItem?.color || 'text-hive-text-secondary';
  };

  const getRarityGlow = (rarity: AchievementRarity): string => {
    switch (rarity) {
      case 'common':
        return 'shadow-gray-500/20';
      case 'uncommon':
        return 'shadow-green-500/20';
      case 'rare':
        return 'shadow-blue-500/20';
      case 'epic':
        return 'shadow-purple-500/20';
      case 'legendary':
        return 'shadow-yellow-500/20';
      default:
        return '';
    }
  };

  const getProgressPercentage = (achievement: Achievement): number => {
    if (!achievement.progress) return 0;
    return Math.min((achievement.progress.current / achievement.progress.total) * 100, 100);
  };

  return (
    <div className={cn("space-y-6", className)}>
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-hive-text-primary">Achievement System</h2>
          <p className="text-hive-text-secondary">
            Track your campus journey and unlock rewards
          </p>
        </div>
        
        <div className="flex items-center gap-3">
          <HiveButton variant="outline" size="sm" onClick={() => setShowSecrets(!showSecrets)}>
            {showSecrets ? <EyeOff className="h-4 w-4 mr-2" /> : <Eye className="h-4 w-4 mr-2" />}
            {showSecrets ? 'Hide' : 'Show'} Secrets
          </HiveButton>
          
          {isOwnProfile && (
            <HiveButton variant="outline" size="sm">
              <Download className="h-4 w-4 mr-2" />
              Export Progress
            </HiveButton>
          )}
        </div>
      </div>

      {/* Achievement Stats Overview */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <HiveCard className="p-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-hive-gold/20 flex items-center justify-center">
              <Trophy className="h-6 w-6 text-hive-gold" />
            </div>
            <div>
              <p className="text-2xl font-bold text-hive-text-primary">{stats.totalEarned}</p>
              <p className="text-sm text-hive-text-secondary">Achievements Earned</p>
            </div>
          </div>
        </HiveCard>

        <HiveCard className="p-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
              <Target className="h-6 w-6 text-blue-500" />
            </div>
            <div>
              <p className="text-2xl font-bold text-hive-text-primary">
                {Math.round(stats.completionRate)}%
              </p>
              <p className="text-sm text-hive-text-secondary">Completion Rate</p>
            </div>
          </div>
        </HiveCard>

        <HiveCard className="p-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <Star className="h-6 w-6 text-purple-500" />
            </div>
            <div>
              <p className="text-2xl font-bold text-hive-text-primary">
                {stats.totalPoints.toLocaleString()}
              </p>
              <p className="text-sm text-hive-text-secondary">Achievement Points</p>
            </div>
          </div>
        </HiveCard>

        <HiveCard className="p-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-orange-500/20 flex items-center justify-center">
              <Flame className="h-6 w-6 text-orange-500" />
            </div>
            <div>
              <p className="text-2xl font-bold text-hive-text-primary">
                {stats.streaks[0]?.current || 0}
              </p>
              <p className="text-sm text-hive-text-secondary">Current Streak</p>
            </div>
          </div>
        </HiveCard>
      </div>

      {/* Recent Achievements */}
      {stats.recentAchievements.length > 0 && (
        <HiveCard className="p-6">
          <h3 className="text-lg font-semibold text-hive-text-primary mb-4">
            Recent Achievements
          </h3>
          
          <div className="flex gap-4 overflow-x-auto pb-2">
            {stats.recentAchievements.map((achievement) => (
              <motion.div
                key={achievement.id}
                initial={{ opacity: 0, scale: 0.8 }}
                animate={{ opacity: 1, scale: 1 }}
                className="flex-shrink-0"
              >
                <div className="text-center p-4 bg-hive-background-primary rounded-lg min-w-[120px]">
                  <div className="text-3xl mb-2">{achievement.icon}</div>
                  <p className="text-sm font-medium text-hive-text-primary truncate">
                    {achievement.name}
                  </p>
                  <Badge className={getRarityColor(achievement.rarity)}>
                    {achievement.rarity}
                  </Badge>
                </div>
              </motion.div>
            ))}
          </div>
        </HiveCard>
      )}

      {/* Navigation Tabs */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          {[
            { id: 'overview', label: 'Overview' },
            { id: 'earned', label: `Earned (${achievements.filter(a => a.status === 'completed').length})` },
            { id: 'progress', label: `In Progress (${achievements.filter(a => a.status === 'in_progress').length})` },
            { id: 'available', label: `Available (${achievements.filter(a => a.status === 'available' || a.status === 'locked').length})` }
          ].map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id as any)}
              className={cn(
                "px-4 py-2 rounded-lg transition-colors",
                activeTab === tab.id
                  ? "bg-hive-gold text-hive-text-primary"
                  : "text-hive-text-secondary hover:text-hive-text-primary hover:bg-hive-surface-elevated"
              )}
            >
              {tab.label}
            </button>
          ))}
        </div>

        <div className="flex items-center gap-3">
          {/* Search */}
          <div className="relative">
            <Search className="h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-hive-text-secondary" />
            <input
              type="text"
              placeholder="Search achievements..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10 pr-4 py-2 bg-hive-surface-elevated border border-hive-border-subtle rounded-lg text-hive-text-primary placeholder-hive-text-secondary focus:outline-none focus:ring-2 focus:ring-hive-gold w-64"
            />
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="flex flex-wrap items-center gap-4">
        {/* Category Filter */}
        <div className="flex items-center gap-2">
          <span className="text-sm font-medium text-hive-text-secondary">Category:</span>
          <select
            value={selectedCategory}
            onChange={(e) => setSelectedCategory(e.target.value as any)}
            className="px-3 py-2 bg-hive-surface-elevated border border-hive-border-subtle rounded-lg text-hive-text-primary focus:outline-none focus:ring-2 focus:ring-hive-gold"
          >
            {categories.map((category) => (
              <option key={category.id} value={category.id}>
                {category.label}
              </option>
            ))}
          </select>
        </div>

        {/* Rarity Filter */}
        <div className="flex items-center gap-2">
          <span className="text-sm font-medium text-hive-text-secondary">Rarity:</span>
          <select
            value={selectedRarity}
            onChange={(e) => setSelectedRarity(e.target.value as any)}
            className="px-3 py-2 bg-hive-surface-elevated border border-hive-border-subtle rounded-lg text-hive-text-primary focus:outline-none focus:ring-2 focus:ring-hive-gold"
          >
            {rarities.map((rarity) => (
              <option key={rarity.id} value={rarity.id}>
                {rarity.label}
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* Achievements Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <AnimatePresence mode="popLayout">
          {filteredAchievements.map((achievement) => (
            <motion.div
              key={achievement.id}
              layout
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.9 }}
              transition={{ duration: 0.2 }}
            >
              <AchievementCard
                achievement={achievement}
                onClick={() => onAchievementClick?.(achievement)}
                onClaim={() => onClaimReward?.(achievement)}
                onShare={() => onShareAchievement?.(achievement)}
                isOwnProfile={isOwnProfile}
              />
            </motion.div>
          ))}
        </AnimatePresence>
      </div>

      {/* Empty State */}
      {filteredAchievements.length === 0 && (
        <div className="text-center py-12">
          <div className="w-20 h-20 rounded-full bg-hive-surface-elevated flex items-center justify-center mx-auto mb-4">
            <Award className="h-10 w-10 text-hive-text-secondary" />
          </div>
          <h3 className="text-lg font-semibold text-hive-text-primary mb-2">
            No achievements found
          </h3>
          <p className="text-hive-text-secondary">
            Try adjusting your search or filter criteria
          </p>
        </div>
      )}
    </div>
  );
};

// Achievement Card Component
interface AchievementCardProps {
  achievement: Achievement;
  onClick: () => void;
  onClaim: () => void;
  onShare: () => void;
  isOwnProfile: boolean;
}

const AchievementCard: React.FC<AchievementCardProps> = ({
  achievement,
  onClick,
  onClaim,
  onShare,
  isOwnProfile
}) => {
  const isLocked = achievement.status === 'locked';
  const isCompleted = achievement.status === 'completed';
  const inProgress = achievement.status === 'in_progress';
  const progressPercentage = achievement.progress 
    ? Math.min((achievement.progress.current / achievement.progress.total) * 100, 100)
    : 0;

  const getRarityColor = (rarity: AchievementRarity): string => {
    switch (rarity) {
      case 'common':
        return 'text-gray-400 border-gray-400/20';
      case 'uncommon':
        return 'text-green-400 border-green-400/20';
      case 'rare':
        return 'text-blue-400 border-blue-400/20';
      case 'epic':
        return 'text-purple-400 border-purple-400/20';
      case 'legendary':
        return 'text-yellow-400 border-yellow-400/20';
      default:
        return 'text-hive-text-secondary border-hive-border-subtle';
    }
  };

  const getRarityGlow = (rarity: AchievementRarity): string => {
    if (!isCompleted) return '';
    
    switch (rarity) {
      case 'rare':
        return 'shadow-lg shadow-blue-500/20';
      case 'epic':
        return 'shadow-lg shadow-purple-500/20';
      case 'legendary':
        return 'shadow-xl shadow-yellow-500/30';
      default:
        return '';
    }
  };

  return (
    <HiveCard 
      className={cn(
        "p-6 cursor-pointer transition-all duration-200 hover:shadow-lg",
        isCompleted && getRarityGlow(achievement.rarity),
        isLocked && "opacity-75"
      )}
      onClick={onClick}
    >
      {/* Achievement Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className={cn(
            "w-12 h-12 rounded-xl flex items-center justify-center text-2xl transition-all",
            isCompleted ? "bg-hive-gold/20" : "bg-hive-surface-elevated",
            isLocked && "grayscale"
          )}>
            {isLocked && achievement.isSecret ? '?' : achievement.icon}
          </div>
          
          <div className="flex-1 min-w-0">
            <h4 className={cn(
              "font-semibold truncate",
              isCompleted ? "text-hive-text-primary" : "text-hive-text-secondary",
              isLocked && achievement.isSecret && "text-hive-text-tertiary"
            )}>
              {isLocked && achievement.isSecret ? 'Secret Achievement' : achievement.name}
            </h4>
            <Badge className={getRarityColor(achievement.rarity)}>
              {achievement.rarity}
            </Badge>
          </div>
        </div>

        {isCompleted && (
          <CheckCircle className="h-5 w-5 text-green-500 flex-shrink-0" />
        )}
        {isLocked && (
          <Lock className="h-5 w-5 text-hive-text-tertiary flex-shrink-0" />
        )}
      </div>

      {/* Achievement Description */}
      <p className={cn(
        "text-sm mb-4 line-clamp-2",
        isCompleted ? "text-hive-text-primary" : "text-hive-text-secondary",
        isLocked && achievement.isSecret && "text-hive-text-tertiary"
      )}>
        {isLocked && achievement.isSecret 
          ? 'Complete certain actions to unlock this achievement'
          : achievement.description
        }
      </p>

      {/* Progress Bar */}
      {inProgress && achievement.progress && (
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-xs text-hive-text-secondary">Progress</span>
            <span className="text-xs text-hive-text-primary font-medium">
              {achievement.progress.current} / {achievement.progress.total}
              {achievement.progress.unit && ` ${achievement.progress.unit}`}
            </span>
          </div>
          <div className="w-full bg-hive-background-primary rounded-full h-2">
            <div
              className="bg-hive-gold h-2 rounded-full transition-all duration-300"
              style={{ width: `${progressPercentage}%` }}
            />
          </div>
        </div>
      )}

      {/* Achievement Footer */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span className="text-xs text-hive-text-secondary">
            {achievement.points} points
          </span>
          {achievement.isLimited && (
            <Badge variant="secondary" className="text-xs">
              Limited
            </Badge>
          )}
        </div>

        {isCompleted && isOwnProfile && (
          <HiveButton
            variant="ghost" 
            size="sm"
            onClick={(e) => { e.stopPropagation(); onShare(); }}
          >
            <Share2 className="h-4 w-4" />
          </HiveButton>
        )}
      </div>

      {/* Completion Rate */}
      <div className="mt-3 pt-3 border-t border-hive-border-subtle">
        <div className="flex items-center justify-between text-xs text-hive-text-tertiary">
          <span>Earned by {achievement.completedBy.toLocaleString()} students</span>
          <span>{achievement.completionRate.toFixed(1)}% completion</span>
        </div>
      </div>
    </HiveCard>
  );
};

export default AchievementSystem;