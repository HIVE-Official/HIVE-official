'use client';

import React, { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from './framer-motion-proxy';
import { cn } from '../lib/utils';
import { 
  Heart, 
  MessageCircle, 
  Share2, 
  MoreHorizontal, 
  Crown, 
  Calendar, 
  MapPin, 
  Users, 
  CheckCircle, 
  AlertCircle,
  Clock,
  Bookmark,
  Flag,
  Pin,
  Eye
} from 'lucide-react';

export interface PostAuthor {
  id: string;
  name: string;
  avatar?: string;
  role?: 'leader' | 'co_leader' | 'member';
  verified?: boolean;
}

export interface PostReaction {
  emoji: string;
  count: number;
  userReacted?: boolean;
  users?: { id: string; name: string }[];
}

export interface PostAttachment {
  id: string;
  type: 'image' | 'file' | 'link';
  url: string;
  name: string;
  size?: number;
  preview?: string;
}

export interface PostEvent {
  id: string;
  title: string;
  date: string;
  location?: string;
  rsvpCount?: number;
  userRsvp?: 'yes' | 'no' | 'maybe' | null;
}

export interface PostPoll {
  id: string;
  question: string;
  options: Array<{
    id: string;
    text: string;
    votes: number;
    userVoted?: boolean;
  }>;
  totalVotes: number;
  expiresAt?: string;
  allowMultiple?: boolean;
}

export interface PostAnnouncement {
  priority: 'low' | 'medium' | 'high' | 'urgent';
  isPinned?: boolean;
  expiresAt?: string;
}

export interface SpacePost {
  id: string;
  type: 'text' | 'event' | 'poll' | 'announcement' | 'tool_output';
  content: string;
  author: PostAuthor;
  timestamp: string;
  editedAt?: string;
  
  // Engagement
  reactions?: PostReaction[];
  commentCount?: number;
  shareCount?: number;
  viewCount?: number;
  
  // Attachments
  attachments?: PostAttachment[];
  
  // Special post types
  event?: PostEvent;
  poll?: PostPoll;
  announcement?: PostAnnouncement;
  
  // Tool-generated metadata
  toolSource?: {
    toolId: string;
    toolName: string;
    icon: string;
  };
  
  // Moderation
  isPinned?: boolean;
  isEdited?: boolean;
  isReported?: boolean;
}

export interface PostBoardProps {
  posts: SpacePost[];
  currentUser?: {
    id: string;
    role?: 'leader' | 'co_leader' | 'member';
  };
  
  // Interaction handlers
  onReaction?: (postId: string, emoji: string, add: boolean) => void;
  onComment?: (postId: string) => void;
  onShare?: (postId: string) => void;
  onEdit?: (postId: string) => void;
  onDelete?: (postId: string) => void;
  onPin?: (postId: string, pin: boolean) => void;
  onReport?: (postId: string) => void;
  onEventRsvp?: (eventId: string, response: 'yes' | 'no' | 'maybe') => void;
  onPollVote?: (pollId: string, optionId: string) => void;
  
  // Display options
  showComments?: boolean;
  enableInfiniteScroll?: boolean;
  className?: string;
}

const PostReactionBar: React.FC<{
  reactions: PostReaction[];
  onReaction: (emoji: string, add: boolean) => void;
}> = ({ reactions, onReaction }) => {
  const popularReactions = ['üëç', '‚ù§Ô∏è', 'üòä', 'üéâ', 'üëè'];
  
  return (
    <div className="flex items-center gap-2 flex-wrap">
      {/* Existing reactions */}
      {reactions.map((reaction, index) => (
        <motion.button
          key={`${reaction.emoji}-${index}`}
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
          onClick={() => onReaction(reaction.emoji, !reaction.userReacted)}
          className={cn(
            'flex items-center gap-1 px-2 py-1 rounded-full text-sm transition-all duration-200',
            reaction.userReacted
              ? 'bg-[var(--hive-brand-primary)]/20 border border-[var(--hive-brand-primary)]/40 text-[var(--hive-brand-primary)]'
              : 'bg-[var(--hive-background-tertiary)]/40 border border-[var(--hive-border-primary)]/20 text-[var(--hive-text-secondary)] hover:bg-[var(--hive-background-tertiary)]/60'
          )}
        >
          <span>{reaction.emoji}</span>
          <span className="font-medium">{reaction.count}</span>
        </motion.button>
      ))}
      
      {/* Quick add reactions */}
      {popularReactions
        .filter(emoji => !reactions.find(r => r.emoji === emoji))
        .slice(0, 3)
        .map(emoji => (
          <motion.button
            key={emoji}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={() => onReaction(emoji, true)}
            className="w-8 h-8 rounded-full bg-[var(--hive-background-tertiary)]/40 border border-[var(--hive-border-primary)]/20 flex items-center justify-center text-sm hover:bg-[var(--hive-background-tertiary)]/60 transition-all duration-200"
          >
            {emoji}
          </motion.button>
        ))}
    </div>
  );
};

const PostEventCard: React.FC<{
  event: PostEvent;
  onRsvp?: (response: 'yes' | 'no' | 'maybe') => void;
}> = ({ event, onRsvp }) => {
  return (
    <div className="mt-3 p-4 bg-[var(--hive-brand-primary)]/10 border border-[var(--hive-brand-primary)]/20 rounded-2xl">
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-[var(--hive-brand-primary)]/20 border border-[var(--hive-brand-primary)]/30 flex items-center justify-center">
            <Calendar className="w-5 h-5 text-[var(--hive-brand-primary)]" />
          </div>
          
          <div>
            <h4 className="font-semibold text-[var(--hive-text-primary)]">{event.title}</h4>
            <div className="flex items-center gap-4 text-sm text-[var(--hive-text-secondary)] mt-1">
              <div className="flex items-center gap-1">
                <Clock className="w-3 h-3" />
                <span>{new Date(event.date).toLocaleDateString()}</span>
              </div>
              {event.location && (
                <div className="flex items-center gap-1">
                  <MapPin className="w-3 h-3" />
                  <span>{event.location}</span>
                </div>
              )}
              {event.rsvpCount && (
                <div className="flex items-center gap-1">
                  <Users className="w-3 h-3" />
                  <span>{event.rsvpCount} attending</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {onRsvp && (
        <div className="flex items-center gap-2">
          <span className="text-sm text-[var(--hive-text-secondary)] mr-2">Will you attend?</span>
          {['yes', 'no', 'maybe'].map((response) => (
            <motion.button
              key={response}
              whileHover={{ scale: 1.02 }}
              whileTap={{ scale: 0.98 }}
              onClick={() => onRsvp(response as 'yes' | 'no' | 'maybe')}
              className={cn(
                'px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200',
                event.userRsvp === response
                  ? 'bg-[var(--hive-brand-primary)]/20 text-[var(--hive-brand-primary)] border border-[var(--hive-brand-primary)]/40'
                  : 'bg-[var(--hive-background-primary)]/50 text-[var(--hive-text-secondary)] border border-[var(--hive-border-primary)]/30 hover:bg-[var(--hive-background-primary)]/70'
              )}
            >
              {response === 'yes' && '‚úì Yes'}
              {response === 'no' && '‚úó No'}
              {response === 'maybe' && '? Maybe'}
            </motion.button>
          ))}
        </div>
      )}
    </div>
  );
};

const PostPollCard: React.FC<{
  poll: PostPoll;
  onVote?: (optionId: string) => void;
}> = ({ poll, onVote }) => {
  const hasVoted = poll.options.some(option => option.userVoted);
  const timeLeft = poll.expiresAt ? new Date(poll.expiresAt).getTime() - Date.now() : null;
  const isExpired = timeLeft !== null && timeLeft <= 0;

  return (
    <div className="mt-3 p-4 bg-[var(--hive-status-info)]/10 border border-[var(--hive-status-info)]/20 rounded-2xl">
      <div className="flex items-center gap-2 mb-3">
        <CheckCircle className="w-5 h-5 text-[var(--hive-status-info)]" />
        <h4 className="font-semibold text-[var(--hive-text-primary)]">{poll.question}</h4>
      </div>

      <div className="space-y-2 mb-4">
        {poll.options.map((option) => {
          const percentage = poll.totalVotes > 0 ? (option.votes / poll.totalVotes) * 100 : 0;
          
          return (
            <motion.div
              key={option.id}
              whileHover={!hasVoted && !isExpired ? { scale: 1.01 } : {}}
              className={cn(
                'relative overflow-hidden rounded-xl border transition-all duration-200',
                hasVoted || isExpired 
                  ? 'cursor-default' 
                  : 'cursor-pointer hover:border-[var(--hive-status-info)]/40'
              )}
              onClick={() => !hasVoted && !isExpired && onVote?.(option.id)}
            >
              {/* Progress bar */}
              <div 
                className="absolute inset-0 bg-[var(--hive-status-info)]/10 transition-all duration-500"
                style={{ width: `${percentage}%` }}
              />
              
              <div className="relative z-10 flex items-center justify-between px-4 py-3">
                <div className="flex items-center gap-2">
                  {option.userVoted && (
                    <CheckCircle className="w-4 h-4 text-[var(--hive-status-info)]" />
                  )}
                  <span className={cn(
                    'font-medium',
                    option.userVoted 
                      ? 'text-[var(--hive-status-info)]' 
                      : 'text-[var(--hive-text-primary)]'
                  )}>
                    {option.text}
                  </span>
                </div>
                
                <div className="flex items-center gap-2 text-sm text-[var(--hive-text-secondary)]">
                  <span>{option.votes} votes</span>
                  {(hasVoted || isExpired) && (
                    <span className="font-medium">({percentage.toFixed(1)}%)</span>
                  )}
                </div>
              </div>
            </motion.div>
          );
        }}
      </div>

      <div className="flex items-center justify-between text-xs text-[var(--hive-text-muted)]">
        <span>{poll.totalVotes} total votes</span>
        {timeLeft !== null && !isExpired && (
          <span>Expires in {Math.floor(timeLeft / (1000 * 60 * 60 * 24))} days</span>
        )}
        {isExpired && <span className="text-[var(--hive-status-warning)]">Poll expired</span>}
      </div>
    </div>
  );
};

const PostCard: React.FC<{
  post: SpacePost;
  currentUser?: { id: string; role?: string };
  onReaction?: (emoji: string, add: boolean) => void;
  onComment?: () => void;
  onShare?: () => void;
  onEdit?: () => void;
  onDelete?: () => void;
  onPin?: (pin: boolean) => void;
  onReport?: () => void;
  onEventRsvp?: (response: 'yes' | 'no' | 'maybe') => void;
  onPollVote?: (optionId: string) => void;
}> = ({ 
  post, 
  currentUser, 
  onReaction, 
  onComment, 
  onShare, 
  onEdit, 
  onDelete, 
  onPin, 
  onReport,
  onEventRsvp,
  onPollVote
}) => {
  const [showMenu, setShowMenu] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  const canEdit = currentUser?.id === post.author.id;
  const canPin = currentUser?.role === 'leader' || currentUser?.role === 'co_leader';
  const canDelete = canEdit || canPin;

  const formatTimeAgo = (timestamp: string): string => {
    const now = new Date();
    const time = new Date(timestamp);
    const diffInHours = Math.floor((now.getTime() - time.getTime()) / (1000 * 60 * 60));
    
    if (diffInHours < 1) return 'Just now';
    if (diffInHours < 24) return `${diffInHours}h ago`;
    if (diffInHours < 168) return `${Math.floor(diffInHours / 24)}d ago`;
    return `${Math.floor(diffInHours / 168)}w ago`;
  };

  const getPriorityColor = (priority?: string) => {
    switch (priority) {
      case 'urgent': return 'border-red-500/40 bg-red-500/10';
      case 'high': return 'border-orange-500/40 bg-orange-500/10';
      case 'medium': return 'border-yellow-500/40 bg-yellow-500/10';
      default: return 'border-[var(--hive-border-primary)]/20 bg-[var(--hive-background-secondary)]/60';
    }
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setShowMenu(false);
      }
    };

    if (showMenu) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [showMenu]);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className={cn(
        'relative backdrop-blur-xl border rounded-2xl p-6 transition-all duration-300',
        post.type === 'announcement' 
          ? getPriorityColor(post.announcement?.priority)
          : 'border-[var(--hive-border-primary)]/20 bg-[var(--hive-background-secondary)]/60',
        post.isPinned && 'ring-2 ring-[var(--hive-brand-primary)]/20'
      )}
    >
      {/* Pinned indicator */}
      {post.isPinned && (
        <div className="absolute -top-2 -right-2 w-8 h-8 bg-[var(--hive-brand-primary)]/20 border border-[var(--hive-brand-primary)]/40 rounded-full flex items-center justify-center">
          <Pin className="w-4 h-4 text-[var(--hive-brand-primary)]" />
        </div>
      )}

      {/* Post Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 rounded-xl bg-[var(--hive-background-tertiary)]/60 border border-[var(--hive-border-primary)]/30 flex items-center justify-center">
            <span className="text-lg font-bold text-[var(--hive-text-primary)]">
              {post.author.name.charAt(0)}
            </span>
          </div>
          
          <div>
            <div className="flex items-center gap-2">
              <span className="font-semibold text-[var(--hive-text-primary)]">
                {post.author.name}
              </span>
              
              {post.author.role === 'leader' && (
                <Crown className="w-4 h-4 text-[var(--hive-brand-secondary)]" />
              )}
              
              {post.author.verified && (
                <CheckCircle className="w-4 h-4 text-[var(--hive-status-success)]" />
              )}
              
              {post.toolSource && (
                <div className="flex items-center gap-1 px-2 py-0.5 bg-[var(--hive-status-info)]/20 border border-[var(--hive-status-info)]/30 rounded-full">
                  <span className="text-xs">{post.toolSource.icon}</span>
                  <span className="text-xs font-medium text-[var(--hive-status-info)]">
                    {post.toolSource.toolName}
                  </span>
                </div>
              )}
            </div>
            
            <div className="flex items-center gap-2 text-sm text-[var(--hive-text-muted)] mt-0.5">
              <span>{formatTimeAgo(post.timestamp)}</span>
              {post.isEdited && <span>‚Ä¢ edited</span>}
              {post.viewCount && (
                <div className="flex items-center gap-1">
                  <Eye className="w-3 h-3" />
                  <span>{post.viewCount}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Actions Menu */}
        <div className="relative" ref={menuRef}>
          <button
            onClick={() => setShowMenu(!showMenu)}
            className="w-8 h-8 rounded-lg flex items-center justify-center text-[var(--hive-text-muted)] hover:text-[var(--hive-text-primary)] hover:bg-[var(--hive-background-primary)]/50 transition-colors duration-200"
          >
            <MoreHorizontal className="w-4 h-4" />
          </button>

          <AnimatePresence>
            {showMenu && (
              <motion.div
                initial={{ opacity: 0, scale: 0.95, y: -10 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: -10 }}
                className="absolute right-0 top-10 w-48 bg-[var(--hive-background-secondary)]/95 backdrop-blur-xl border border-[var(--hive-border-primary)]/30 rounded-xl shadow-lg z-50 py-2"
              >
                {canEdit && (
                  <button
                    onClick={() => {
                      onEdit?.();
                      setShowMenu(false);
                    }}
                    className="w-full px-4 py-2 text-left text-sm text-[var(--hive-text-primary)] hover:bg-[var(--hive-background-primary)]/50 transition-colors duration-200"
                  >
                    Edit post
                  </button>
                )}
                
                {canPin && (
                  <button
                    onClick={() => {
                      onPin?.(!post.isPinned);
                      setShowMenu(false);
                    }}
                    className="w-full px-4 py-2 text-left text-sm text-[var(--hive-text-primary)] hover:bg-[var(--hive-background-primary)]/50 transition-colors duration-200"
                  >
                    {post.isPinned ? 'Unpin post' : 'Pin post'}
                  </button>
                )}
                
                <button
                  onClick={() => {
                    onReport?.();
                    setShowMenu(false);
                  }}
                  className="w-full px-4 py-2 text-left text-sm text-[var(--hive-status-warning)] hover:bg-[var(--hive-background-primary)]/50 transition-colors duration-200"
                >
                  Report post
                </button>
                
                {canDelete && (
                  <button
                    onClick={() => {
                      onDelete?.();
                      setShowMenu(false);
                    }}
                    className="w-full px-4 py-2 text-left text-sm text-[var(--hive-status-error)] hover:bg-[var(--hive-background-primary)]/50 transition-colors duration-200"
                  >
                    Delete post
                  </button>
                )}
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>

      {/* Post Content */}
      <div className="mb-4">
        <p className="text-[var(--hive-text-primary)] leading-relaxed whitespace-pre-wrap">
          {post.content}
        </p>
      </div>

      {/* Special Content Types */}
      {post.event && (
        <PostEventCard 
          event={post.event} 
          onRsvp={onEventRsvp} 
        />
      )}

      {post.poll && (
        <PostPollCard 
          poll={post.poll} 
          onVote={onPollVote} 
        />
      )}

      {/* Post Footer */}
      <div className="flex items-center justify-between pt-4 border-t border-[var(--hive-border-primary)]/10">
        {/* Reactions */}
        <div className="flex-1">
          {post.reactions && post.reactions.length > 0 && onReaction && (
            <PostReactionBar 
              reactions={post.reactions} 
              onReaction={onReaction} 
            />
          )}
        </div>

        {/* Action Buttons */}
        <div className="flex items-center gap-2 ml-4">
          {post.commentCount !== undefined && (
            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              onClick={onComment}
              className="flex items-center gap-1 px-3 py-1.5 rounded-xl text-sm text-[var(--hive-text-secondary)] hover:text-[var(--hive-text-primary)] hover:bg-[var(--hive-background-primary)]/50 transition-all duration-200"
            >
              <MessageCircle className="w-4 h-4" />
              <span>{post.commentCount}</span>
            </motion.button>
          )}

          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={onShare}
            className="flex items-center gap-1 px-3 py-1.5 rounded-xl text-sm text-[var(--hive-text-secondary)] hover:text-[var(--hive-text-primary)] hover:bg-[var(--hive-background-primary)]/50 transition-all duration-200"
          >
            <Share2 className="w-4 h-4" />
            {post.shareCount && <span>{post.shareCount}</span>}
          </motion.button>

          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            className="w-8 h-8 rounded-xl flex items-center justify-center text-[var(--hive-text-secondary)] hover:text-[var(--hive-text-primary)] hover:bg-[var(--hive-background-primary)]/50 transition-all duration-200"
          >
            <Bookmark className="w-4 h-4" />
          </motion.button>
        </div>
      </div>
    </motion.div>
  );
};

export const PostBoard: React.FC<PostBoardProps> = ({
  posts,
  currentUser,
  onReaction,
  onComment,
  onShare,
  onEdit,
  onDelete,
  onPin,
  onReport,
  onEventRsvp,
  onPollVote,
  showComments = true,
  enableInfiniteScroll = false,
  className
}) => {
  const sortedPosts = React.useMemo(() => {
    return [...posts].sort((a, b) => {
      // Pinned posts first
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      
      // Then by timestamp
      return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
    });
  }, [posts]);

  if (posts.length === 0) {
    return (
      <div className={cn('text-center py-12', className)}>
        <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--hive-background-tertiary)]/40 border border-[var(--hive-border-primary)]/20 flex items-center justify-center">
          <MessageCircle className="w-8 h-8 text-[var(--hive-text-muted)]" />
        </div>
        <h3 className="text-lg font-semibold text-[var(--hive-text-primary)] mb-2">
          No posts yet
        </h3>
        <p className="text-[var(--hive-text-secondary)]">
          Be the first to share something with this community
        </p>
      </div>
    );
  }

  return (
    <div className={cn('space-y-6', className)}>
      <AnimatePresence>
        {sortedPosts.map((post) => (
          <PostCard
            key={post.id}
            post={post}
            currentUser={currentUser}
            onReaction={onReaction ? (emoji, add) => onReaction(post.id, emoji, add) : undefined}
            onComment={onComment ? () => onComment(post.id) : undefined}
            onShare={onShare ? () => onShare(post.id) : undefined}
            onEdit={onEdit ? () => onEdit(post.id) : undefined}
            onDelete={onDelete ? () => onDelete(post.id) : undefined}
            onPin={onPin ? (pin) => onPin(post.id, pin) : undefined}
            onReport={onReport ? () => onReport(post.id) : undefined}
            onEventRsvp={onEventRsvp && post.event ? (response) => onEventRsvp(post.event!.id, response) : undefined}
            onPollVote={onPollVote && post.poll ? (optionId) => onPollVote(post.poll!.id, optionId) : undefined}
          />
        ))}
      </AnimatePresence>
    </div>
  );
};

export default PostBoard;