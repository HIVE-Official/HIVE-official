/**
 * HIVE Tool Review System
 * Complete reviews and ratings for tools in the marketplace
 */

import React, { useState, useCallback, useMemo } from 'react';
import { Button } from '../../atomic/atoms/button';
import { Avatar } from '../index';
import { HiveBadge as Badge } from '../index';
import { 
  Star, 
  MessageSquare, 
  ThumbsUp, 
  ThumbsDown,
  Flag,
  Edit3,
  Trash2,
  MoreHorizontal,
  Send,
  Filter,
  ChevronDown,
  Calendar,
  TrendingUp,
  Award,
  CheckCircle,
  AlertTriangle,
  Search,
  X,
  Heart,
  Share
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

export interface ToolReview {
  id: string;
  toolId: string;
  userId: string;
  author: {
    id: string;
    name: string;
    handle: string;
    avatar?: string;
    isVerified?: boolean;
    reviewsCount?: number;
    helpfulVotes?: number;
  };
  rating: number; // 1-5 stars
  title: string;
  content: string;
  pros?: string[];
  cons?: string[];
  useCase?: string;
  wouldRecommend: boolean;
  timestamp: string;
  lastUpdated?: string;
  isEdited?: boolean;
  helpfulVotes: number;
  unhelpfulVotes: number;
  userVote?: 'helpful' | 'unhelpful' | null;
  replies?: ToolReviewReply[];
  isVerifiedPurchase?: boolean;
  usageDuration?: '1week' | '1month' | '3months' | '6months' | '1year+';
  categories?: string[];
  attachments?: {
    id: string;
    type: 'image' | 'video';
    url: string;
    caption?: string;
  }[];
}

export interface ToolReviewReply {
  id: string;
  reviewId: string;
  userId: string;
  author: {
    id: string;
    name: string;
    handle: string;
    avatar?: string;
    isVerified?: boolean;
    isDeveloper?: boolean;
  };
  content: string;
  timestamp: string;
  isEdited?: boolean;
}

export interface ToolRatingsSummary {
  averageRating: number;
  totalReviews: number;
  distribution: {
    5: number;
    4: number;
    3: number;
    2: number;
    1: number;
  };
  recommendationRate: number;
  verifiedPurchaseRate: number;
  categories: {
    usability: number;
    performance: number;
    design: number;
    value: number;
    support: number;
  };
}

interface ToolReviewSystemProps {
  toolId: string;
  reviews: ToolReview[];
  summary: ToolRatingsSummary;
  currentUserId?: string;
  userReview?: ToolReview;
  onSubmitReview?: (review: Omit<ToolReview, 'id' | 'timestamp' | 'author'>) => Promise<void>;
  onUpdateReview?: (reviewId: string, updates: Partial<ToolReview>) => Promise<void>;
  onDeleteReview?: (reviewId: string) => Promise<void>;
  onVoteReview?: (reviewId: string, vote: 'helpful' | 'unhelpful') => Promise<void>;
  onReplyToReview?: (reviewId: string, content: string) => Promise<void>;
  onReportReview?: (reviewId: string, reason: string) => Promise<void>;
  canReview?: boolean;
  isLoading?: boolean;
  enableFeatureFlag?: boolean;
}

interface ReviewFormProps {
  toolId: string;
  existingReview?: ToolReview;
  onSubmit: (review: Omit<ToolReview, 'id' | 'timestamp' | 'author'>) => Promise<void>;
  onCancel?: () => void;
}

interface RatingsSummaryProps {
  summary: ToolRatingsSummary;
}

interface ReviewItemProps {
  review: ToolReview;
  currentUserId?: string;
  onVote?: (reviewId: string, vote: 'helpful' | 'unhelpful') => Promise<void>;
  onReply?: (reviewId: string, content: string) => Promise<void>;
  onEdit?: (reviewId: string) => void;
  onDelete?: (reviewId: string) => Promise<void>;
  onReport?: (reviewId: string, reason: string) => Promise<void>;
}

const StarRating: React.FC<{
  rating: number;
  size?: 'sm' | 'md' | 'lg';
  interactive?: boolean;
  onChange?: (rating: number) => void;
}> = ({ rating, size = 'md', interactive = false, onChange }) => {
  const [hoverRating, setHoverRating] = useState(0);
  
  const sizeClasses = {
    sm: 'w-3 h-3',
    md: 'w-4 h-4',
    lg: 'w-5 h-5'
  };

  const currentRating = interactive ? (hoverRating || rating) : rating;

  return (
    <div className="flex items-center space-x-0.5">
      {[1, 2, 3, 4, 5].map((star) => (
        <button
          key={star}
          disabled={!interactive}
          onMouseEnter={() => interactive && setHoverRating(star)}
          onMouseLeave={() => interactive && setHoverRating(0)}
          onClick={() => interactive && onChange?.(star)}
          className={`${interactive ? 'cursor-pointer hover:scale-110' : 'cursor-default'} transition-transform`}
        >
          <Star
            className={`${sizeClasses[size]} transition-colors ${
              star <= currentRating
                ? 'text-yellow-400 fill-current'
                : 'text-gray-300'
            }`}
          />
        </button>
      ))}
    </div>
  );
};

const RatingsSummary: React.FC<RatingsSummaryProps> = ({ summary }) => {
  const maxCount = Math.max(...Object.values(summary.distribution));

  return (
    <div className="p-6 bg-[var(--hive-background-elevated)] border border-[var(--hive-border-default)] rounded-xl">
      <div className="flex items-start justify-between mb-6">
        <div>
          <div className="flex items-center space-x-3 mb-2">
            <div className="text-3xl font-bold text-[var(--hive-text-primary)]">
              {summary.averageRating.toFixed(1)}
            </div>
            <div>
              <StarRating rating={summary.averageRating} size="lg" />
              <div className="text-sm text-[var(--hive-text-muted)] mt-1">
                {summary.totalReviews} reviews
              </div>
            </div>
          </div>
          <div className="flex items-center space-x-4 text-sm text-[var(--hive-text-secondary)]">
            <span>{(summary.recommendationRate * 100).toFixed(0)}% recommend</span>
            <span>{(summary.verifiedPurchaseRate * 100).toFixed(0)}% verified</span>
          </div>
        </div>

        <div className="text-right">
          <div className="flex items-center space-x-1 text-green-500 mb-1">
            <TrendingUp className="w-4 h-4" />
            <span className="text-sm font-medium">Highly Rated</span>
          </div>
          <Badge variant="secondary" className="flex items-center space-x-1">
            <Award className="w-3 h-3" />
            <span>Editor's Choice</span>
          </Badge>
        </div>
      </div>

      {/* Rating Distribution */}
      <div className="space-y-2 mb-6">
        {[5, 4, 3, 2, 1].map((stars) => (
          <div key={stars} className="flex items-center space-x-3">
            <div className="flex items-center space-x-1 w-12">
              <span className="text-sm text-[var(--hive-text-primary)]">{stars}</span>
              <Star className="w-3 h-3 text-yellow-400 fill-current" />
            </div>
            <div className="flex-1 bg-[var(--hive-background-secondary)] rounded-full h-2">
              <div
                className="bg-yellow-400 h-2 rounded-full transition-all duration-300"
                style={{
                  width: `${maxCount > 0 ? (summary.distribution[stars as keyof typeof summary.distribution] / maxCount) * 100 : 0}%`
                }}
              />
            </div>
            <span className="text-sm text-[var(--hive-text-muted)] w-8 text-right">
              {summary.distribution[stars as keyof typeof summary.distribution]}
            </span>
          </div>
        ))}
      </div>

      {/* Category Ratings */}
      <div>
        <h4 className="font-medium text-[var(--hive-text-primary)] mb-3">Category Breakdown</h4>
        <div className="grid grid-cols-2 gap-4">
          {Object.entries(summary.categories).map(([category, rating]) => (
            <div key={category}>
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm text-[var(--hive-text-secondary)] capitalize">{category}</span>
                <span className="text-sm font-medium text-[var(--hive-text-primary)]">{rating.toFixed(1)}</span>
              </div>
              <div className="bg-[var(--hive-background-secondary)] rounded-full h-1.5">
                <div
                  className="bg-[var(--hive-primary)] h-1.5 rounded-full transition-all duration-300"
                  style={{ width: `${(rating / 5) * 100}%` }}
                />
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

const ReviewForm: React.FC<ReviewFormProps> = ({
  toolId,
  existingReview,
  onSubmit,
  onCancel
}) => {
  const [formData, setFormData] = useState({
    rating: existingReview?.rating || 0,
    title: existingReview?.title || '',
    content: existingReview?.content || '',
    pros: existingReview?.pros || [''],
    cons: existingReview?.cons || [''],
    useCase: existingReview?.useCase || '',
    wouldRecommend: existingReview?.wouldRecommend ?? true,
    usageDuration: existingReview?.usageDuration || '1month' as const,
    categories: existingReview?.categories || []
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  const validateForm = () => {
    const newErrors: Record<string, string> = {};
    
    if (formData.rating === 0) newErrors.rating = 'Please select a rating';
    if (!formData.title.trim()) newErrors.title = 'Title is required';
    if (!formData.content.trim()) newErrors.content = 'Review content is required';
    if (formData.content.length < 50) newErrors.content = 'Review must be at least 50 characters';
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = useCallback(async () => {
    if (!validateForm() || isSubmitting) return;
    
    setIsSubmitting(true);
    try {
      const reviewData = {
        ...formData,
        toolId,
        userId: '', // Will be set by the API
        pros: formData.pros.filter(p => p.trim()),
        cons: formData.cons.filter(c => c.trim()),
        helpfulVotes: 0,
        unhelpfulVotes: 0,
        userVote: null,
        replies: []
      };
      
      await onSubmit(reviewData);
      onCancel?.();
    } catch (error) {
      console.error('Failed to submit review:', error);
    } finally {
      setIsSubmitting(false);
    }
  }, [formData, toolId, onSubmit, onCancel, isSubmitting]);

  const addPro = () => setFormData(prev => ({ ...prev, pros: [...prev.pros, ''] }));
  const removePro = (index: number) => setFormData(prev => ({ 
    ...prev, 
    pros: prev.pros.filter((_, i) => i !== index) 
  }));
  const updatePro = (index: number, value: string) => setFormData(prev => ({
    ...prev,
    pros: prev.pros.map((p, i) => i === index ? value : p)
  }));

  const addCon = () => setFormData(prev => ({ ...prev, cons: [...prev.cons, ''] }));
  const removeCon = (index: number) => setFormData(prev => ({ 
    ...prev, 
    cons: prev.cons.filter((_, i) => i !== index) 
  }));
  const updateCon = (index: number, value: string) => setFormData(prev => ({
    ...prev,
    cons: prev.cons.map((c, i) => i === index ? value : c)
  }));

  return (
    <div className="p-6 bg-[var(--hive-background-elevated)] border border-[var(--hive-border-default)] rounded-xl">
      <h3 className="text-lg font-semibold text-[var(--hive-text-primary)] mb-6">
        {existingReview ? 'Edit Your Review' : 'Write a Review'}
      </h3>

      <div className="space-y-6">
        {/* Rating */}
        <div>
          <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
            Overall Rating *
          </label>
          <StarRating
            rating={formData.rating}
            size="lg"
            interactive
            onChange={(rating) => setFormData(prev => ({ ...prev, rating }))}
          />
          {errors.rating && (
            <p className="text-sm text-red-400 mt-1">{errors.rating}</p>
          )}
        </div>

        {/* Title */}
        <div>
          <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
            Review Title *
          </label>
          <input
            type="text"
            value={formData.title}
            onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
            placeholder="Summarize your experience..."
            className="w-full p-3 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-[var(--hive-primary)]"
          />
          {errors.title && (
            <p className="text-sm text-red-400 mt-1">{errors.title}</p>
          )}
        </div>

        {/* Content */}
        <div>
          <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
            Review Content *
          </label>
          <textarea
            value={formData.content}
            onChange={(e) => setFormData(prev => ({ ...prev, content: e.target.value }))}
            placeholder="Share your detailed experience with this tool..."
            rows={6}
            className="w-full p-3 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-[var(--hive-primary)] resize-none"
          />
          <div className="flex items-center justify-between mt-1">
            <div className="text-sm text-[var(--hive-text-muted)]">
              {formData.content.length}/1000 characters
            </div>
            {errors.content && (
              <p className="text-sm text-red-400">{errors.content}</p>
            )}
          </div>
        </div>

        {/* Pros and Cons */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Pros */}
          <div>
            <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
              Pros
            </label>
            <div className="space-y-2">
              {formData.pros.map((pro, index) => (
                <div key={index} className="flex items-center space-x-2">
                  <input
                    type="text"
                    value={pro}
                    onChange={(e) => updatePro(index, e.target.value)}
                    placeholder="What did you like?"
                    className="flex-1 p-2 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-green-500"
                  />
                  <Button
                    variant="ghost"
                    size="xs"
                    onClick={() => removePro(index)}
                    className="text-red-400 hover:text-red-300"
                  >
                    <X className="w-3 h-3" />
                  </Button>
                </div>
              ))}
              <Button
                variant="outline"
                size="sm"
                onClick={addPro}
                className="w-full border-dashed"
              >
                Add Pro
              </Button>
            </div>
          </div>

          {/* Cons */}
          <div>
            <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
              Cons
            </label>
            <div className="space-y-2">
              {formData.cons.map((con, index) => (
                <div key={index} className="flex items-center space-x-2">
                  <input
                    type="text"
                    value={con}
                    onChange={(e) => updateCon(index, e.target.value)}
                    placeholder="What could be improved?"
                    className="flex-1 p-2 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-red-500"
                  />
                  <Button
                    variant="ghost"
                    size="xs"
                    onClick={() => removeCon(index)}
                    className="text-red-400 hover:text-red-300"
                  >
                    <X className="w-3 h-3" />
                  </Button>
                </div>
              ))}
              <Button
                variant="outline"
                size="sm"
                onClick={addCon}
                className="w-full border-dashed"
              >
                Add Con
              </Button>
            </div>
          </div>
        </div>

        {/* Use Case */}
        <div>
          <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
            Use Case (Optional)
          </label>
          <input
            type="text"
            value={formData.useCase}
            onChange={(e) => setFormData(prev => ({ ...prev, useCase: e.target.value }))}
            placeholder="How did you use this tool?"
            className="w-full p-3 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-[var(--hive-primary)]"
          />
        </div>

        {/* Usage Duration and Recommendation */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
              Usage Duration
            </label>
            <select
              value={formData.usageDuration}
              onChange={(e) => setFormData(prev => ({ ...prev, usageDuration: e.target.value as any }))}
              className="w-full p-3 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] focus:outline-none focus:border-[var(--hive-primary)]"
            >
              <option value="1week">Less than a week</option>
              <option value="1month">1 month</option>
              <option value="3months">3 months</option>
              <option value="6months">6 months</option>
              <option value="1year+">1 year or more</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-[var(--hive-text-primary)] mb-2">
              Recommendation
            </label>
            <div className="flex items-center space-x-4 mt-3">
              <label className="flex items-center space-x-2 cursor-pointer">
                <input
                  type="radio"
                  checked={formData.wouldRecommend}
                  onChange={() => setFormData(prev => ({ ...prev, wouldRecommend: true }))}
                  className="text-[var(--hive-primary)]"
                />
                <span className="text-[var(--hive-text-primary)]">Yes, I recommend this</span>
              </label>
              <label className="flex items-center space-x-2 cursor-pointer">
                <input
                  type="radio"
                  checked={!formData.wouldRecommend}
                  onChange={() => setFormData(prev => ({ ...prev, wouldRecommend: false }))}
                  className="text-[var(--hive-primary)]"
                />
                <span className="text-[var(--hive-text-primary)]">No, I don't recommend</span>
              </label>
            </div>
          </div>
        </div>

        {/* Actions */}
        <div className="flex items-center justify-end space-x-3 pt-4 border-t border-[var(--hive-border-subtle)]">
          {onCancel && (
            <Button
              variant="outline"
              onClick={onCancel}
              disabled={isSubmitting}
            >
              Cancel
            </Button>
          )}
          <Button
            onClick={handleSubmit}
            disabled={isSubmitting}
            className="bg-[var(--hive-primary)] text-white"
          >
            {isSubmitting ? (
              <div className="w-4 h-4 border border-white border-t-transparent rounded-full animate-spin mr-2" />
            ) : null}
            {existingReview ? 'Update Review' : 'Submit Review'}
          </Button>
        </div>
      </div>
    </div>
  );
};

const ReviewItem: React.FC<ReviewItemProps> = ({
  review,
  currentUserId,
  onVote,
  onReply,
  onEdit,
  onDelete,
  onReport
}) => {
  const [showReplies, setShowReplies] = useState(false);
  const [showReplyForm, setShowReplyForm] = useState(false);
  const [replyContent, setReplyContent] = useState('');
  const [showMenu, setShowMenu] = useState(false);
  const [isSubmittingReply, setIsSubmittingReply] = useState(false);

  const isOwnReview = currentUserId === review.userId;
  const totalVotes = review.helpfulVotes + review.unhelpfulVotes;
  const helpfulPercentage = totalVotes > 0 ? (review.helpfulVotes / totalVotes) * 100 : 0;

  const formatTimeAgo = (timestamp: string) => {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 30) return `${diffDays} days ago`;
    if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
    return `${Math.floor(diffDays / 365)} years ago`;
  };

  const handleVote = useCallback(async (vote: 'helpful' | 'unhelpful') => {
    await onVote?.(review.id, vote);
  }, [review.id, onVote]);

  const handleReply = useCallback(async () => {
    if (!replyContent.trim() || isSubmittingReply) return;
    
    setIsSubmittingReply(true);
    try {
      await onReply?.(review.id, replyContent);
      setReplyContent('');
      setShowReplyForm(false);
      setShowReplies(true);
    } finally {
      setIsSubmittingReply(false);
    }
  }, [review.id, replyContent, onReply, isSubmittingReply]);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="p-6 bg-[var(--hive-background-elevated)] border border-[var(--hive-border-default)] rounded-xl"
    >
      {/* Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex items-center space-x-3">
          <Avatar
            src={review.author.avatar}
            initials={review.author.name.charAt(0)}
            size="md"
          />
          <div>
            <div className="flex items-center space-x-2">
              <h4 className="font-medium text-[var(--hive-text-primary)]">{review.author.name}</h4>
              {review.author.isVerified && (
                <CheckCircle className="w-4 h-4 text-[var(--hive-primary)]" />
              )}
              {review.isVerifiedPurchase && (
                <Badge size="xs" className="bg-green-500/10 text-green-400 border-green-500/20">
                  Verified
                </Badge>
              )}
            </div>
            <div className="flex items-center space-x-2 text-sm text-[var(--hive-text-muted)]">
              <span>@{review.author.handle}</span>
              <span>•</span>
              <span>{formatTimeAgo(review.timestamp)}</span>
              {review.isEdited && (
                <>
                  <span>•</span>
                  <span>Edited</span>
                </>
              )}
            </div>
          </div>
        </div>

        <div className="flex items-center space-x-2">
          <StarRating rating={review.rating} size="sm" />
          <div className="relative">
            <Button
              variant="ghost"
              size="xs"
              onClick={() => setShowMenu(!showMenu)}
            >
              <MoreHorizontal className="w-3 h-3" />
            </Button>

            <AnimatePresence>
              {showMenu && (
                <motion.div
                  initial={{ opacity: 0, scale: 0.95, y: -10 }}
                  animate={{ opacity: 1, scale: 1, y: 0 }}
                  exit={{ opacity: 0, scale: 0.95, y: -10 }}
                  className="absolute top-full right-0 mt-1 bg-[var(--hive-background-elevated)] border border-[var(--hive-border-default)] rounded-lg shadow-lg py-1 z-20 min-w-[140px]"
                >
                  {isOwnReview ? (
                    <>
                      <button
                        onClick={() => {
                          onEdit?.(review.id);
                          setShowMenu(false);
                        }}
                        className="w-full px-3 py-1.5 text-left text-sm hover:bg-[var(--hive-background-secondary)] flex items-center gap-2"
                      >
                        <Edit3 className="w-3 h-3" />
                        Edit Review
                      </button>
                      <button
                        onClick={() => {
                          onDelete?.(review.id);
                          setShowMenu(false);
                        }}
                        className="w-full px-3 py-1.5 text-left text-sm hover:bg-[var(--hive-background-secondary)] flex items-center gap-2 text-red-400"
                      >
                        <Trash2 className="w-3 h-3" />
                        Delete Review
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        onClick={() => {
                          // Handle share
                          setShowMenu(false);
                        }}
                        className="w-full px-3 py-1.5 text-left text-sm hover:bg-[var(--hive-background-secondary)] flex items-center gap-2"
                      >
                        <Share className="w-3 h-3" />
                        Share Review
                      </button>
                      <button
                        onClick={() => {
                          onReport?.(review.id, 'inappropriate');
                          setShowMenu(false);
                        }}
                        className="w-full px-3 py-1.5 text-left text-sm hover:bg-[var(--hive-background-secondary)] flex items-center gap-2 text-orange-400"
                      >
                        <Flag className="w-3 h-3" />
                        Report Review
                      </button>
                    </>
                  )}
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      </div>

      {/* Review Content */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-[var(--hive-text-primary)]">{review.title}</h3>
        <p className="text-[var(--hive-text-secondary)] leading-relaxed">{review.content}</p>

        {/* Pros and Cons */}
        {(review.pros && review.pros.length > 0) || (review.cons && review.cons.length > 0) ? (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {review.pros && review.pros.length > 0 && (
              <div>
                <h4 className="font-medium text-green-400 mb-2 flex items-center space-x-2">
                  <ThumbsUp className="w-4 h-4" />
                  <span>Pros</span>
                </h4>
                <ul className="space-y-1">
                  {review.pros.map((pro, index) => (
                    <li key={index} className="text-sm text-[var(--hive-text-secondary)] flex items-start space-x-2">
                      <span className="text-green-400 mt-1">+</span>
                      <span>{pro}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {review.cons && review.cons.length > 0 && (
              <div>
                <h4 className="font-medium text-red-400 mb-2 flex items-center space-x-2">
                  <ThumbsDown className="w-4 h-4" />
                  <span>Cons</span>
                </h4>
                <ul className="space-y-1">
                  {review.cons.map((con, index) => (
                    <li key={index} className="text-sm text-[var(--hive-text-secondary)] flex items-start space-x-2">
                      <span className="text-red-400 mt-1">-</span>
                      <span>{con}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        ) : null}

        {/* Use Case */}
        {review.useCase && (
          <div className="p-3 bg-[var(--hive-background-secondary)] rounded-lg">
            <h4 className="font-medium text-[var(--hive-text-primary)] mb-1">Use Case</h4>
            <p className="text-sm text-[var(--hive-text-secondary)]">{review.useCase}</p>
          </div>
        )}

        {/* Recommendation */}
        <div className="flex items-center space-x-2">
          {review.wouldRecommend ? (
            <CheckCircle className="w-4 h-4 text-green-400" />
          ) : (
            <AlertTriangle className="w-4 h-4 text-red-400" />
          )}
          <span className="text-sm text-[var(--hive-text-secondary)]">
            {review.wouldRecommend ? 'Recommends this tool' : 'Does not recommend this tool'}
          </span>
        </div>
      </div>

      {/* Actions */}
      <div className="flex items-center justify-between mt-6 pt-4 border-t border-[var(--hive-border-subtle)]">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => handleVote('helpful')}
              className={`flex items-center space-x-1 ${
                review.userVote === 'helpful' ? 'text-green-400' : 'text-[var(--hive-text-muted)]'
              }`}
            >
              <ThumbsUp className="w-4 h-4" />
              <span>{review.helpfulVotes}</span>
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => handleVote('unhelpful')}
              className={`flex items-center space-x-1 ${
                review.userVote === 'unhelpful' ? 'text-red-400' : 'text-[var(--hive-text-muted)]'
              }`}
            >
              <ThumbsDown className="w-4 h-4" />
              <span>{review.unhelpfulVotes}</span>
            </Button>
          </div>

          {totalVotes > 5 && (
            <div className="text-sm text-[var(--hive-text-muted)]">
              {helpfulPercentage.toFixed(0)}% found this helpful
            </div>
          )}
        </div>

        <div className="flex items-center space-x-2">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setShowReplyForm(!showReplyForm)}
            className="flex items-center space-x-1"
          >
            <MessageSquare className="w-4 h-4" />
            <span>Reply</span>
          </Button>

          {review.replies && review.replies.length > 0 && (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setShowReplies(!showReplies)}
              className="flex items-center space-x-1"
            >
              <ChevronDown className={`w-4 h-4 transition-transform ${showReplies ? 'rotate-180' : ''}`} />
              <span>{review.replies.length} replies</span>
            </Button>
          )}
        </div>
      </div>

      {/* Reply Form */}
      <AnimatePresence>
        {showReplyForm && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            className="mt-4 pt-4 border-t border-[var(--hive-border-subtle)]"
          >
            <div className="flex space-x-3">
              <textarea
                value={replyContent}
                onChange={(e) => setReplyContent(e.target.value)}
                placeholder="Share your thoughts on this review..."
                rows={3}
                className="flex-1 p-3 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-[var(--hive-primary)] resize-none"
              />
              <div className="flex flex-col space-y-2">
                <Button
                  size="sm"
                  onClick={handleReply}
                  disabled={!replyContent.trim() || isSubmittingReply}
                  className="bg-[var(--hive-primary)] text-white"
                >
                  {isSubmittingReply ? (
                    <div className="w-3 h-3 border border-white border-t-transparent rounded-full animate-spin" />
                  ) : (
                    <Send className="w-3 h-3" />
                  )}
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => setShowReplyForm(false)}
                >
                  <X className="w-3 h-3" />
                </Button>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Replies */}
      <AnimatePresence>
        {showReplies && review.replies && review.replies.length > 0 && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
            className="mt-4 pt-4 border-t border-[var(--hive-border-subtle)] space-y-3"
          >
            {review.replies.map((reply) => (
              <div key={reply.id} className="flex space-x-3 p-3 bg-[var(--hive-background-secondary)] rounded-lg">
                <Avatar
                  src={reply.author.avatar}
                  initials={reply.author.name.charAt(0)}
                  size="sm"
                />
                <div className="flex-1 min-w-0">
                  <div className="flex items-center space-x-2 mb-1">
                    <span className="font-medium text-[var(--hive-text-primary)] text-sm">{reply.author.name}</span>
                    {reply.author.isDeveloper && (
                      <Badge size="xs" className="bg-blue-500/10 text-blue-400 border-blue-500/20">
                        Developer
                      </Badge>
                    )}
                    <span className="text-xs text-[var(--hive-text-muted)]">
                      {formatTimeAgo(reply.timestamp)}
                    </span>
                  </div>
                  <p className="text-sm text-[var(--hive-text-secondary)]">{reply.content}</p>
                </div>
              </div>
            ))}
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
};

export const ToolReviewSystem: React.FC<ToolReviewSystemProps> = ({
  toolId,
  reviews,
  summary,
  currentUserId,
  userReview,
  onSubmitReview,
  onUpdateReview,
  onDeleteReview,
  onVoteReview,
  onReplyToReview,
  onReportReview,
  canReview = true,
  isLoading = false,
  enableFeatureFlag = true
}) => {
  const [showReviewForm, setShowReviewForm] = useState(false);
  const [editingReviewId, setEditingReviewId] = useState<string | null>(null);
  const [sortBy, setSortBy] = useState<'newest' | 'oldest' | 'highest' | 'lowest' | 'helpful'>('newest');
  const [filterBy, setFilterBy] = useState<'all' | '5' | '4' | '3' | '2' | '1'>('all');
  const [searchQuery, setSearchQuery] = useState('');

  // Feature flag check
  if (!enableFeatureFlag) return null;

  const filteredAndSortedReviews = useMemo(() => {
    let filtered = reviews;

    // Apply search
    if (searchQuery) {
      filtered = filtered.filter(review =>
        review.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        review.content.toLowerCase().includes(searchQuery.toLowerCase()) ||
        review.author.name.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    // Apply filter
    if (filterBy !== 'all') {
      filtered = filtered.filter(review => review.rating === parseInt(filterBy));
    }

    // Apply sort
    const sorted = [...filtered].sort((a, b) => {
      switch (sortBy) {
        case 'newest':
          return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
        case 'oldest':
          return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
        case 'highest':
          return b.rating - a.rating;
        case 'lowest':
          return a.rating - b.rating;
        case 'helpful':
          return b.helpfulVotes - a.helpfulVotes;
        default:
          return 0;
      }
    });

    return sorted;
  }, [reviews, searchQuery, filterBy, sortBy]);

  const handleSubmitReview = useCallback(async (reviewData: Omit<ToolReview, 'id' | 'timestamp' | 'author'>) => {
    await onSubmitReview?.(reviewData);
    setShowReviewForm(false);
  }, [onSubmitReview]);

  const handleEditReview = useCallback((reviewId: string) => {
    setEditingReviewId(reviewId);
    setShowReviewForm(true);
  }, []);

  return (
    <div className="space-y-6">
      {/* Ratings Summary */}
      <RatingsSummary summary={summary} />

      {/* Review Actions */}
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-4">
          <h2 className="text-xl font-semibold text-[var(--hive-text-primary)]">
            Reviews ({summary.totalReviews})
          </h2>
          {canReview && !userReview && (
            <Button
              onClick={() => setShowReviewForm(true)}
              className="bg-[var(--hive-primary)] text-white"
            >
              Write a Review
            </Button>
          )}
          {userReview && (
            <Button
              variant="outline"
              onClick={() => handleEditReview(userReview.id)}
            >
              Edit Your Review
            </Button>
          )}
        </div>

        {/* Search and Filters */}
        <div className="flex items-center space-x-3">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-[var(--hive-text-muted)]" />
            <input
              type="text"
              placeholder="Search reviews..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10 pr-4 py-2 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] placeholder-[var(--hive-text-muted)] focus:outline-none focus:border-[var(--hive-primary)]"
            />
          </div>

          <select
            value={filterBy}
            onChange={(e) => setFilterBy(e.target.value as any)}
            className="px-3 py-2 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] focus:outline-none focus:border-[var(--hive-primary)]"
          >
            <option value="all">All Ratings</option>
            <option value="5">5 Stars</option>
            <option value="4">4 Stars</option>
            <option value="3">3 Stars</option>
            <option value="2">2 Stars</option>
            <option value="1">1 Star</option>
          </select>

          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value as any)}
            className="px-3 py-2 bg-[var(--hive-background-secondary)] border border-[var(--hive-border-default)] rounded-lg text-[var(--hive-text-primary)] focus:outline-none focus:border-[var(--hive-primary)]"
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="highest">Highest Rating</option>
            <option value="lowest">Lowest Rating</option>
            <option value="helpful">Most Helpful</option>
          </select>
        </div>
      </div>

      {/* Review Form */}
      <AnimatePresence>
        {showReviewForm && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
          >
            <ReviewForm
              toolId={toolId}
              existingReview={editingReviewId ? reviews.find(r => r.id === editingReviewId) : undefined}
              onSubmit={handleSubmitReview}
              onCancel={() => {
                setShowReviewForm(false);
                setEditingReviewId(null);
              }}
            />
          </motion.div>
        )}
      </AnimatePresence>

      {/* Reviews List */}
      <div className="space-y-4">
        {isLoading ? (
          <div className="text-center py-8">
            <div className="w-8 h-8 border-2 border-[var(--hive-primary)] border-t-transparent rounded-full animate-spin mx-auto mb-4" />
            <p className="text-[var(--hive-text-muted)]">Loading reviews...</p>
          </div>
        ) : filteredAndSortedReviews.length === 0 ? (
          <div className="text-center py-12">
            <Star className="w-12 h-12 text-[var(--hive-text-muted)] mx-auto mb-4" />
            <h3 className="text-lg font-medium text-[var(--hive-text-primary)] mb-2">
              {searchQuery || filterBy !== 'all' ? 'No reviews found' : 'No reviews yet'}
            </h3>
            <p className="text-[var(--hive-text-muted)]">
              {searchQuery || filterBy !== 'all' 
                ? 'Try adjusting your search or filters'
                : 'Be the first to review this tool!'
              }
            </p>
          </div>
        ) : (
          filteredAndSortedReviews.map((review) => (
            <ReviewItem
              key={review.id}
              review={review}
              currentUserId={currentUserId}
              onVote={onVoteReview}
              onReply={onReplyToReview}
              onEdit={handleEditReview}
              onDelete={onDeleteReview}
              onReport={onReportReview}
            />
          ))
        )}
      </div>
    </div>
  );
};