"use client";

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Bell,
  X,
  Check,
  MessageCircle,
  Heart,
  Users,
  Zap,
  Award,
  Calendar,
  AlertCircle,
  Info,
  ChevronRight,
  Filter,
  MoreHorizontal
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '../../atomic/ui/card';
import { Button } from '../hive-button';
import { Badge } from '../../atomic/atoms/badge';
import { Avatar, AvatarFallback, AvatarImage } from '../../atomic/atoms/avatar';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../../atomic/ui/tabs';

// Notification interfaces
export interface HiveNotification {
  id: string;
  type: 'mention' | 'like' | 'comment' | 'space_invite' | 'tool_update' | 'achievement' | 'reminder' | 'system';
  title: string;
  message: string;
  timestamp: string;
  isRead: boolean;
  actionUrl?: string;
  imageUrl?: string;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  metadata?: {
    userId?: string;
    userName?: string;
    spaceId?: string;
    spaceName?: string;
    toolId?: string;
    toolName?: string;
    achievementId?: string;
    eventId?: string;
  };
}

interface NotificationCenterProps {
  notifications: HiveNotification[];
  onNotificationRead: (notificationId: string) => void;
  onNotificationAction: (notificationId: string, action: string) => void;
  onMarkAllRead: () => void;
  onNotificationClick: (notification: HiveNotification) => void;
  className?: string;
}

// Animation variants
const containerVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      staggerChildren: 0.05,
      delayChildren: 0.1
    }
  }
};

const notificationVariants = {
  hidden: { opacity: 0, x: -20 },
  visible: { 
    opacity: 1, 
    x: 0,
    transition: {
      type: "spring" as const,
      stiffness: 100,
      damping: 15
    }
  },
  exit: {
    opacity: 0,
    x: 20,
    transition: {
      duration: 0.2
    }
  }
} as const;

export function NotificationCenter({
  notifications,
  onNotificationRead,
  onNotificationAction,
  onMarkAllRead,
  onNotificationClick,
  className = ""
}: NotificationCenterProps) {
  const [activeTab, setActiveTab] = useState<'all' | 'unread' | 'mentions' | 'achievements'>('all');
  const [isExpanded, setIsExpanded] = useState(false);

  // Filter notifications based on active tab
  const filteredNotifications = notifications.filter(notification => {
    switch (activeTab) {
      case 'unread':
        return !notification.isRead;
      case 'mentions':
        return notification.type === 'mention' || notification.type === 'comment';
      case 'achievements':
        return notification.type === 'achievement';
      default:
        return true;
    }
  });

  // Group notifications by priority
  const groupedNotifications = filteredNotifications.reduce((acc, notification) => {
    if (!acc[notification.priority]) acc[notification.priority] = [];
    acc[notification.priority].push(notification);
    return acc;
  }, {} as Record<string, HiveNotification[]>);

  // Get notification icon
  const getNotificationIcon = (type: HiveNotification['type']) => {
    switch (type) {
      case 'mention':
      case 'comment':
        return <MessageCircle className="h-4 w-4" />;
      case 'like':
        return <Heart className="h-4 w-4" />;
      case 'space_invite':
        return <Users className="h-4 w-4" />;
      case 'tool_update':
        return <Zap className="h-4 w-4" />;
      case 'achievement':
        return <Award className="h-4 w-4" />;
      case 'reminder':
        return <Calendar className="h-4 w-4" />;
      case 'system':
        return <Info className="h-4 w-4" />;
      default:
        return <Bell className="h-4 w-4" />;
    }
  };

  // Get notification color
  const getNotificationColor = (type: HiveNotification['type'], priority: HiveNotification['priority']) => {
    if (priority === 'urgent') return 'text-red-400 bg-red-500/20';
    if (priority === 'high') return 'text-orange-400 bg-orange-500/20';
    
    switch (type) {
      case 'mention':
      case 'comment':
        return 'text-blue-400 bg-blue-500/20';
      case 'like':
        return 'text-pink-400 bg-pink-500/20';
      case 'space_invite':
        return 'text-purple-400 bg-purple-500/20';
      case 'tool_update':
        return 'text-green-400 bg-green-500/20';
      case 'achievement':
        return 'text-yellow-400 bg-yellow-500/20';
      case 'reminder':
        return 'text-indigo-400 bg-indigo-500/20';
      default:
        return 'text-gray-400 bg-gray-500/20';
    }
  };

  // Format time ago
  const formatTimeAgo = (timestamp: string) => {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    if (minutes > 0) return `${minutes}m ago`;
    return 'Just now';
  };

  const unreadCount = notifications.filter(n => !n.isRead).length;

  return (
    <Card className={`notification-center ${className}`}>
      <CardHeader className="pb-4">
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center space-x-2">
            <Bell className="h-5 w-5 text-hive-gold" />
            <span>Notifications</span>
            {unreadCount > 0 && (
              <Badge variant="secondary" className="bg-hive-gold text-hive-obsidian">
                {unreadCount}
              </Badge>
            )}
          </CardTitle>
          <div className="flex items-center space-x-2">
            <Button 
              variant="ghost" 
              size="sm"
              onClick={onMarkAllRead}
              disabled={unreadCount === 0}
            >
              <Check className="h-4 w-4 mr-1" />
              Mark All Read
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setIsExpanded(!isExpanded)}
            >
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </CardHeader>
      
      <CardContent>
        {/* Notification Tabs */}
        <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as any)} className="mb-4">
          <TabsList className="grid w-full grid-cols-4 bg-hive-background-overlay">
            <TabsTrigger value="all" className="text-xs">
              All
              <Badge variant="secondary" className="ml-1 text-xs">
                {notifications.length}
              </Badge>
            </TabsTrigger>
            <TabsTrigger value="unread" className="text-xs">
              Unread
              {unreadCount > 0 && (
                <Badge variant="secondary" className="ml-1 text-xs bg-hive-gold text-hive-obsidian">
                  {unreadCount}
                </Badge>
              )}
            </TabsTrigger>
            <TabsTrigger value="mentions" className="text-xs">
              Mentions
            </TabsTrigger>
            <TabsTrigger value="achievements" className="text-xs">
              Awards
            </TabsTrigger>
          </TabsList>
        </Tabs>

        {/* Notifications List */}
        <motion.div
          className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"
          variants={containerVariants}
          initial="hidden"
          animate="visible"
        >
          <AnimatePresence mode="popLayout">
            {filteredNotifications.length === 0 ? (
              <motion.div
                className="text-center py-8"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
              >
                <Bell className="h-12 w-12 mx-auto mb-4 text-hive-text-mutedLight opacity-50" />
                <p className="text-hive-text-mutedLight">
                  {activeTab === 'unread' ? 'No unread notifications' : 'No notifications yet'}
                </p>
              </motion.div>
            ) : (
              // Render notifications by priority
              ['urgent', 'high', 'medium', 'low'].map(priority => (
                groupedNotifications[priority] && (
                  <div key={priority} className="space-y-2">
                    {priority === 'urgent' && (
                      <div className="flex items-center space-x-2 text-xs text-red-400 font-medium mb-2">
                        <AlertCircle className="h-3 w-3" />
                        <span>Urgent</span>
                      </div>
                    )}
                    {groupedNotifications[priority].map((notification) => (
                      <NotificationItem
                        key={notification.id}
                        notification={notification}
                        onRead={onNotificationRead}
                        onAction={onNotificationAction}
                        onClick={onNotificationClick}
                        getIcon={getNotificationIcon}
                        getColor={getNotificationColor}
                        formatTimeAgo={formatTimeAgo}
                      />
                    ))}
                  </div>
                )
              ))
            )}
          </AnimatePresence>
        </motion.div>

        {/* Expanded View Options */}
        {isExpanded && (
          <motion.div
            className="mt-4 pt-4 border-t border-hive-border-default space-y-3"
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            exit={{ opacity: 0, height: 0 }}
          >
            <div className="flex items-center justify-between text-sm">
              <span className="text-hive-text-mutedLight">Notification Settings</span>
              <Button 
                variant="ghost" 
                size="sm"
                onClick={() => console.log('Open notification settings')}
              >
                <Filter className="h-4 w-4 mr-1" />
                Customize
              </Button>
            </div>
            
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className="p-2 rounded bg-hive-background-overlay">
                <p className="text-white font-medium">Email Notifications</p>
                <p className="text-hive-text-mutedLight">Important updates only</p>
              </div>
              <div className="p-2 rounded bg-hive-background-overlay">
                <p className="text-white font-medium">Push Notifications</p>
                <p className="text-hive-text-mutedLight">All activities</p>
              </div>
            </div>
          </motion.div>
        )}
      </CardContent>
    </Card>
  );
}

// Individual Notification Item Component
interface NotificationItemProps {
  notification: HiveNotification;
  onRead: (id: string) => void;
  onAction: (id: string, action: string) => void;
  onClick: (notification: HiveNotification) => void;
  getIcon: (type: HiveNotification['type']) => React.ReactNode;
  getColor: (type: HiveNotification['type'], priority: HiveNotification['priority']) => string;
  formatTimeAgo: (timestamp: string) => string;
}

function NotificationItem({
  notification,
  onRead,
  onAction,
  onClick,
  getIcon,
  getColor,
  formatTimeAgo
}: NotificationItemProps) {
  return (
    <motion.div
      variants={notificationVariants}
      layout
      className={`notification-item p-3 rounded-lg border transition-all duration-200 cursor-pointer group hover:bg-hive-background-interactive ${
        notification.isRead 
          ? 'bg-hive-background-overlay border-hive-border-default opacity-70' 
          : 'bg-hive-background-overlay border-hive-border-default hover:border-hive-gold/30'
      }`}
      onClick={() => onClick(notification)}
    >
      <div className="flex items-start space-x-3">
        {/* Notification Icon */}
        <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${getColor(notification.type, notification.priority)}`}>
          {getIcon(notification.type)}
        </div>
        
        {/* Notification Content */}
        <div className="flex-1 min-w-0 space-y-1">
          <div className="flex items-center justify-between">
            <h4 className={`text-sm font-medium transition-colors ${
              notification.isRead ? 'text-hive-text-mutedLight' : 'text-white group-hover:text-hive-gold'
            }`}>
              {notification.title}
            </h4>
            <div className="flex items-center space-x-2">
              {!notification.isRead && (
                <div className="w-2 h-2 bg-hive-gold rounded-full animate-pulse"></div>
              )}
              <span className="text-xs text-hive-text-mutedLight">
                {formatTimeAgo(notification.timestamp)}
              </span>
            </div>
          </div>
          
          <p className={`text-sm transition-colors ${
            notification.isRead ? 'text-hive-text-mutedLight' : 'text-hive-silver'
          }`}>
            {notification.message}
          </p>
          
          {/* Metadata */}
          {(notification.metadata?.spaceName || notification.metadata?.toolName) && (
            <div className="flex items-center space-x-2 text-xs">
              {notification.metadata.spaceName && (
                <Badge variant="outline" className="text-xs">
                  {notification.metadata.spaceName}
                </Badge>
              )}
              {notification.metadata.toolName && (
                <Badge variant="outline" className="text-xs">
                  {notification.metadata.toolName}
                </Badge>
              )}
            </div>
          )}
        </div>
        
        {/* Action Buttons */}
        <div className="flex-shrink-0 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
          {!notification.isRead && (
            <Button
              variant="ghost"
              size="sm"
              onClick={(e) => {
                e.stopPropagation();
                onRead(notification.id);
              }}
              className="h-6 w-6 p-0"
            >
              <Check className="h-3 w-3" />
            </Button>
          )}
          
          {notification.actionUrl && (
            <Button
              variant="ghost"
              size="sm"
              onClick={(e) => {
                e.stopPropagation();
                onAction(notification.id, 'navigate');
              }}
              className="h-6 w-6 p-0"
            >
              <ChevronRight className="h-3 w-3" />
            </Button>
          )}
        </div>
      </div>
    </motion.div>
  );
}

export default NotificationCenter;