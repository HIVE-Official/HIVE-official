import type { Meta, StoryObj } from '@storybook/react';
import React, { useState } from 'react';
import { Button } from '../atomic/atoms/button-enhanced';
import { InputEnhanced as Input } from '../atomic/atoms/input-enhanced';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../atomic/molecules/card';

// =============================================================================
// INDIVIDUAL AUTH COMPONENTS SHOWCASE
// =============================================================================

/**
 * # Auth Components Showcase
 * 
 * Individual authentication components used throughout the HIVE auth flow.
 * These components can be used independently or combined to create custom auth experiences.
 * 
 * ## Components Included
 * - Email input with validation
 * - Password input with strength indicator
 * - Magic link request form
 * - Email verification display
 * - Auth error states
 * - Loading states and animations
 */

// Email Input Component
function EmailInputComponent({ 
  onEmailChange, 
  error, 
  loading = false 
}: { 
  onEmailChange?: (email: string) => void;
  error?: string;
  loading?: boolean;
}) {
  const [email, setEmail] = useState('');
  const [focused, setFocused] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setEmail(value);
    onEmailChange?.(value);
  };

  const isValidEmail = email.includes('@buffalo.edu') && email.length > 10;

  return (
    <Card className="w-full max-w-md bg-[var(--hive-background-secondary)] border-[var(--hive-border-default)]">
      <CardHeader>
        <CardTitle className="text-[var(--hive-text-primary)]">Email Address</CardTitle>
        <CardDescription className="text-[var(--hive-text-secondary)]">
          Enter your @buffalo.edu email address
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="space-y-2">
          <Input
            type="email"
            placeholder="your.name@buffalo.edu"
            value={email}
            onChange={handleChange}
            onFocus={() => setFocused(true)}
            onBlur={() => setFocused(false)}
            disabled={loading}
            className={`transition-all ${
              error 
                ? 'border-[var(--hive-status-error)] focus:ring-[var(--hive-status-error)]' 
                : isValidEmail 
                ? 'border-[var(--hive-status-success)] focus:ring-[var(--hive-status-success)]'
                : focused 
                ? 'border-[var(--hive-brand-secondary)] focus:ring-[var(--hive-brand-secondary)]'
                : ''
            }`}
          />
          
          {/* Email Validation Feedback */}
          {email && (
            <div className={`text-xs transition-colors ${
              isValidEmail 
                ? 'text-[var(--hive-status-success)]' 
                : 'text-[var(--hive-text-tertiary)]'
            }`}>
              {isValidEmail ? 'âœ“ Valid UB email address' : 'â—‹ Must use @buffalo.edu email'}
            </div>
          )}
          
          {error && (
            <div className="text-xs text-[var(--hive-status-error)] flex items-center gap-1">
              <span>âš </span> {error}
            </div>
          )}
        </div>

        <Button 
          className="w-full" 
          disabled={!isValidEmail || loading}
          variant={isValidEmail ? "primary" : "secondary"}
        >
          {loading ? 'Sending...' : 'Continue'}
        </Button>
      </CardContent>
    </Card>
  );
}

// Password Input Component
function PasswordInputComponent({ 
  showStrength = true,
  onPasswordChange 
}: { 
  showStrength?: boolean;
  onPasswordChange?: (password: string) => void;
}) {
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setPassword(value);
    onPasswordChange?.(value);
  };

  // Password strength calculation
  const getPasswordStrength = (pass: string) => {
    if (pass.length < 6) return { level: 0, text: 'Too short', color: 'text-[var(--hive-status-error)]' };
    if (pass.length < 8) return { level: 1, text: 'Weak', color: 'text-[var(--hive-status-warning)]' };
    if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(pass)) return { level: 2, text: 'Fair', color: 'text-[var(--hive-status-info)]' };
    return { level: 3, text: 'Strong', color: 'text-[var(--hive-status-success)]' };
  };

  const strength = getPasswordStrength(password);

  return (
    <Card className="w-full max-w-md bg-[var(--hive-background-secondary)] border-[var(--hive-border-default)]">
      <CardHeader>
        <CardTitle className="text-[var(--hive-text-primary)]">Password</CardTitle>
        <CardDescription className="text-[var(--hive-text-secondary)]">
          Create a secure password for your account
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="space-y-3">
          <div className="relative">
            <Input
              type={showPassword ? "text" : "password"}
              placeholder="Enter your password"
              value={password}
              onChange={handleChange}
              className="pr-10"
            />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-[var(--hive-text-tertiary)] hover:text-[var(--hive-text-secondary)] transition-colors text-sm"
            >
              {showPassword ? 'Hide' : 'Show'}
            </button>
          </div>
          
          {/* Password Strength Indicator */}
          {showStrength && password && (
            <div className="space-y-2">
              <div className="flex items-center justify-between text-xs">
                <span className="text-[var(--hive-text-tertiary)]">Password strength:</span>
                <span className={strength.color}>{strength.text}</span>
              </div>
              <div className="h-1 bg-[var(--hive-background-tertiary)] rounded-full overflow-hidden">
                <div 
                  className={`h-full transition-all duration-300 ${
                    strength.level === 0 ? 'w-1/4 bg-[var(--hive-status-error)]' :
                    strength.level === 1 ? 'w-2/4 bg-[var(--hive-status-warning)]' :
                    strength.level === 2 ? 'w-3/4 bg-[var(--hive-status-info)]' :
                    'w-full bg-[var(--hive-status-success)]'
                  }`}
                />
              </div>
              <div className="text-xs text-[var(--hive-text-tertiary)]">
                {strength.level < 2 && 'Use uppercase, lowercase, and numbers'}
              </div>
            </div>
          )}
        </div>

        <Button 
          className="w-full" 
          disabled={strength.level < 2}
          variant={strength.level >= 2 ? "primary" : "secondary"}
        >
          Create Account
        </Button>
      </CardContent>
    </Card>
  );
}

// Magic Link Component
function MagicLinkComponent({ 
  email = "student@buffalo.edu",
  onResend 
}: { 
  email?: string;
  onResend?: () => void;
}) {
  const [countdown, setCountdown] = useState(60);
  const [canResend, setCanResend] = useState(false);

  React.useEffect(() => {
    if (countdown > 0 && !canResend) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
      return () => clearTimeout(timer);
    } else if (countdown === 0) {
      setCanResend(true);
    }
  }, [countdown, canResend]);

  const handleResend = (): void => {
    setCountdown(60);
    setCanResend(false);
    onResend?.();
  };

  return (
    <Card className="w-full max-w-md bg-[var(--hive-background-secondary)] border-[var(--hive-border-default)]">
      <CardContent className="pt-6 text-center space-y-6">
        {/* Magic Link Icon */}
        <div className="w-16 h-16 mx-auto rounded-full bg-gradient-to-br from-[var(--hive-brand-secondary)]/20 to-[var(--hive-brand-secondary)]/5 flex items-center justify-center">
          <div className="text-2xl">ðŸ“§</div>
        </div>
        
        <div className="space-y-2">
          <h3 className="text-xl font-semibold text-[var(--hive-text-primary)]">
            Check Your Email
          </h3>
          <p className="text-[var(--hive-text-secondary)] text-sm">
            We sent a magic link to
          </p>
          <p className="font-mono text-sm text-[var(--hive-brand-secondary)]">
            {email}
          </p>
        </div>

        <div className="space-y-4">
          <div className="text-xs text-[var(--hive-text-tertiary)]">
            Click the link in your email to sign in instantly. No password needed!
          </div>

          {/* Resend Timer */}
          <div className="space-y-2">
            {!canResend ? (
              <p className="text-xs text-[var(--hive-text-tertiary)]">
                Resend in {countdown} seconds
              </p>
            ) : (
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={handleResend}
                className="text-[var(--hive-brand-secondary)]"
              >
                Resend Magic Link
              </Button>
            )}
          </div>
        </div>

        <div className="pt-4 border-t border-[var(--hive-border-default)]">
          <Button variant="outline" size="sm" className="w-full">
            Use Password Instead
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}

// Auth Error Component
function AuthErrorComponent({ 
  error = "Invalid email or password",
  onRetry,
  onForgotPassword 
}: { 
  error?: string;
  onRetry?: () => void;
  onForgotPassword?: () => void;
}) {
  return (
    <Card className="w-full max-w-md bg-[var(--hive-background-secondary)] border-[var(--hive-status-error)]">
      <CardContent className="pt-6 text-center space-y-4">
        <div className="w-12 h-12 mx-auto rounded-full bg-[var(--hive-status-error)]/10 flex items-center justify-center">
          <span className="text-[var(--hive-status-error)]">âš </span>
        </div>
        
        <div className="space-y-2">
          <h3 className="text-lg font-semibold text-[var(--hive-text-primary)]">
            Sign In Failed
          </h3>
          <p className="text-[var(--hive-status-error)] text-sm">
            {error}
          </p>
        </div>

        <div className="space-y-3">
          <Button 
            variant="primary" 
            size="sm" 
            className="w-full"
            onClick={onRetry}
          >
            Try Again
          </Button>
          
          <Button 
            variant="ghost" 
            size="sm" 
            className="w-full text-[var(--hive-text-secondary)]"
            onClick={onForgotPassword}
          >
            Forgot Password?
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}

// =============================================================================
// STORYBOOK CONFIGURATION
// =============================================================================

const meta: Meta<typeof EmailInputComponent> = {
  title: 'Auth Components/Individual Components',
  component: EmailInputComponent,
  parameters: {
    layout: 'centered',
    docs: {
      description: {
        component: 'Individual authentication components that can be composed to create custom auth flows.'
      }
    }
    backgrounds: {
      default: 'dark',
      values: [
        { name: 'dark', value: '#0A0A0A' },
        { name: 'light', value: '#FFFFFF' }
      ]
    }
  }
        tags: ['autodocs']
};

export default meta;
type Story = StoryObj<typeof meta>;

// =============================================================================
// INDIVIDUAL COMPONENT STORIES
// =============================================================================

export const EmailInput: Story = {
  name: 'ðŸ“§ Email Input',
  render: () => <EmailInputComponent onEmailChange={(email) => console.log('Email:', email)} />,
  parameters: {
    docs: {
      description: {
        story: 'Email input component with UB email validation and visual feedback states.'
      }
    }
  }
};

export const EmailInputWithError: Story = {
  name: 'âŒ Email Input (Error State)',
  render: () => (
    <EmailInputComponent 
      error="This email is already registered" 
      onEmailChange={(email) => console.log('Email:', email)} 
    />
  )
};

export const EmailInputLoading: Story = {
  name: 'â³ Email Input (Loading State)',
  render: () => (
    <EmailInputComponent 
      loading={true}
      onEmailChange={(email) => console.log('Email:', email)} 
    />
  )
};

export const PasswordInput: Story = {
  name: 'ðŸ”’ Password Input',
  render: () => (
    <PasswordInputComponent onPasswordChange={(password) => console.log('Password strength:', password.length)} />
  ),
  parameters: {
    docs: {
      description: {
        story: 'Password input with real-time strength indicator and visibility toggle.'
      }
    }
  }
};

export const PasswordInputNoStrength: Story = {
  name: 'ðŸ”’ Password Input (No Strength)',
  render: () => (
    <PasswordInputComponent 
      showStrength={false}
      onPasswordChange={(password) => console.log('Password:', password)} 
    />
  )
};

export const MagicLinkSent: Story = {
  name: 'âœ¨ Magic Link Sent',
  render: () => (
    <MagicLinkComponent 
      email="john.doe@buffalo.edu"
      onResend={() => console.log('Magic link resent')} 
    />
  ),
  parameters: {
    docs: {
      description: {
        story: 'Magic link confirmation screen with countdown timer and resend functionality.'
      }
    }
  }
};

export const AuthError: Story = {
  name: 'âš ï¸ Auth Error',
  render: () => (
    <AuthErrorComponent 
      error="Invalid email or password"
      onRetry={() => console.log('Retry clicked')}
      onForgotPassword={() => console.log('Forgot password clicked')}
    />
  ),
  parameters: {
    docs: {
      description: {
        story: 'Authentication error state with retry and forgot password options.'
      }
    }
  }
};

export const AuthErrorNetwork: Story = {
  name: 'ðŸŒ Auth Error (Network)',
  render: () => (
    <AuthErrorComponent 
      error="Network error. Please check your connection and try again."
      onRetry={() => console.log('Retry clicked')}
      onForgotPassword={() => console.log('Forgot password clicked')}
    />
  )
};

// Component Composition Example
export const AuthFormComposition: Story = {
  name: 'ðŸŽ¨ Complete Auth Form',
  render: () => {
    const [step, setStep] = useState<'email' | 'password' | 'magic-link' | 'error'>('email');
    const [email, setEmail] = useState('');
    const [error, setError] = useState<string | null>(null);

    const handleEmailSubmit = (emailValue: string) => {
      if (emailValue.includes('@buffalo.edu')) {
        setEmail(emailValue);
        setStep('password');
        setError(null);
      } else {
        setError('Please use a valid @buffalo.edu email address');
      }
    };

    const handlePasswordSubmit = (): void => {
      // Simulate auth failure for demo
      setError('Invalid credentials');
      setStep('error');
    };

    const handleMagicLink = (): void => {
      setStep('magic-link');
      setError(null);
    };

    const handleRetry = (): void => {
      setStep('email');
      setError(null);
    };

    return (
      <div className="w-full max-w-md mx-auto space-y-4">
        <div className="text-center mb-6">
          <h2 className="text-2xl font-bold text-[var(--hive-text-primary)] mb-2">
            Sign In to HIVE
          </h2>
          <p className="text-[var(--hive-text-secondary)]">
            University of Buffalo
          </p>
        </div>

        {step === 'email' && (
          <EmailInputComponent 
            onEmailChange={handleEmailSubmit} 
            error={error}
          />
        )}

        {step === 'password' && (
          <div className="space-y-4">
            <div className="text-center text-sm text-[var(--hive-text-secondary)]">
              Signing in as: <span className="text-[var(--hive-brand-secondary)]">{email}</span>
            </div>
            <PasswordInputComponent onPasswordChange={handlePasswordSubmit} />
            <div className="text-center">
              <Button variant="ghost" size="sm" onClick={handleMagicLink}>
                Use Magic Link Instead
              </Button>
            </div>
          </div>
        )}

        {step === 'magic-link' && (
          <MagicLinkComponent email={email} />
        )}

        {step === 'error' && (
          <AuthErrorComponent 
            error={error}
            onRetry={handleRetry}
            onForgotPassword={() => console.log('Forgot password')}
          />
        )}
      </div>
    );
  }
  parameters: {
    docs: {
      description: {
        story: 'Example of composing multiple auth components into a complete authentication flow.'
      }
    }
  }
};